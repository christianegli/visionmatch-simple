<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionMatch Admin - Customer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-container {
            overflow-x: auto;
        }
        .encrypted-field {
            font-family: monospace;
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">VisionMatch Customer Dashboard</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-700">Customer Entries</h2>
                <div class="flex gap-4 items-center">
                    <input type="text" id="searchInput" placeholder="Search by email, name, or zip..." 
                           class="px-3 py-1 border rounded" onkeyup="filterCustomers()">
                    <button onclick="loadCustomers()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div id="stats" class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded">
                    <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                    <div class="text-sm text-gray-600">Total Customers</div>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <div class="text-2xl font-bold text-green-600" id="consentCount">0</div>
                    <div class="text-sm text-gray-600">With Consent</div>
                </div>
                <div class="bg-purple-50 p-4 rounded">
                    <div class="text-2xl font-bold text-purple-600" id="todayCount">0</div>
                    <div class="text-sm text-gray-600">Today</div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="pb-2">ID</th>
                            <th class="pb-2">Consent ID</th>
                            <th class="pb-2">Has Email</th>
                            <th class="pb-2">Has Name</th>
                            <th class="pb-2">Has Zip</th>
                            <th class="pb-2">Created</th>
                            <th class="pb-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable" class="divide-y">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Customer Details</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        let customers = [];
        
        async function loadCustomers() {
            try {
                const response = await fetch('http://localhost:3001/api/admin/customers', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin:admin123')
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    customers = data.customers;
                    updateStats();
                    renderTable();
                } else {
                    alert('Error loading customers');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('customerTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center py-4 text-red-500">Error loading data. Is the backend running?</td></tr>';
            }
        }
        
        function updateStats() {
            document.getElementById('totalCount').textContent = customers.length;
            document.getElementById('consentCount').textContent = customers.filter(c => c.consentGiven).length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayCustomers = customers.filter(c => c.createdAt && c.createdAt.startsWith(today));
            document.getElementById('todayCount').textContent = todayCustomers.length;
        }
        
        async function viewDetails(consentId) {
            try {
                const response = await fetch(`http://localhost:3001/api/admin/customers/${consentId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin:admin123'),
                        'X-Consent-ID': consentId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    showModal(data.customer);
                } else {
                    alert('Error loading customer details');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading customer details');
            }
        }
        
        function showModal(customerData) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');
            
            // Format quiz answers nicely
            const formatQuizAnswers = (answers) => {
                if (!answers) return '<p class="text-gray-500">No quiz data available</p>';
                
                return Object.entries(answers).map(([key, value]) => {
                    // Make the key more readable
                    const readableKey = key.replace(/([A-Z])/g, ' $1').trim()
                        .replace(/^\w/, c => c.toUpperCase());
                    
                    // Format the value
                    let formattedValue = value;
                    if (Array.isArray(value)) {
                        formattedValue = value.join(', ');
                    } else if (typeof value === 'object' && value !== null) {
                        formattedValue = JSON.stringify(value, null, 2);
                    }
                    
                    return `
                        <div class="border-b border-gray-200 pb-2 mb-2">
                            <p class="text-sm font-medium text-gray-700">${readableKey}</p>
                            <p class="text-sm text-gray-900 mt-1">${formattedValue}</p>
                        </div>
                    `;
                }).join('');
            };
            
            // Format AI insights
            const formatAIInsights = (insights) => {
                if (!insights) return '<p class="text-gray-500">No AI insights available</p>';
                
                let html = '';
                
                if (insights.initialTeaser) {
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2">Initial Analysis</h5>
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="text-sm">${insights.initialTeaser.headline || 'N/A'}</p>
                                <p class="text-xs text-gray-600 mt-1">${insights.initialTeaser.detail || ''}</p>
                            </div>
                        </div>
                    `;
                }
                
                if (insights.fullReport) {
                    const report = insights.fullReport;
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2">Full Report</h5>
                            <div class="bg-green-50 p-3 rounded space-y-3">
                                ${report.greeting ? `<p class="text-sm font-medium">${report.greeting}</p>` : ''}
                                ${report.executiveSummary ? `<p class="text-sm">${report.executiveSummary}</p>` : ''}
                                
                                ${report.keyFindings && report.keyFindings.length > 0 ? `
                                    <div>
                                        <h6 class="font-semibold text-xs mb-1">Key Findings:</h6>
                                        <ul class="list-disc list-inside text-sm space-y-1">
                                            ${report.keyFindings.map(f => `
                                                <li>
                                                    <strong>${f.finding || 'Finding'}:</strong> ${f.impact || ''}
                                                    ${f.statistic ? `<span class="text-xs text-gray-600">(${f.statistic})</span>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${report.recommendations && report.recommendations.length > 0 ? `
                                    <div>
                                        <h6 class="font-semibold text-xs mb-1">Recommendations:</h6>
                                        <ul class="list-disc list-inside text-sm space-y-1">
                                            ${report.recommendations.map(r => `<li>${r}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return html || '<p class="text-gray-500">No insights generated</p>';
            };
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Personal Information Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <span class="text-blue-500 mr-2">👤</span>
                            Personal Information
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="font-medium">${customerData.personalData.email || 'Not provided'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Full Name</p>
                                <p class="font-medium">${customerData.personalData.firstName || ''} ${customerData.personalData.lastName || ''}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Zip Code</p>
                                <p class="font-medium">${customerData.personalData.zipCode || 'Not provided'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Customer Since</p>
                                <p class="font-medium">${customerData.dataManagement.exportedAt ? new Date(customerData.dataManagement.exportedAt).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consent & GDPR Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            Consent & GDPR Compliance
                        </h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Consent Status</span>
                                <span class="px-2 py-1 text-xs rounded ${customerData.consentData.consentGiven ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${customerData.consentData.consentGiven ? 'Given' : 'Not Given'}
                                </span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Consent Timestamp</p>
                                <p class="text-sm">${new Date(customerData.consentData.consentTimestamp).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Processing Purposes</p>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${customerData.consentData.dataProcessingPurposes.map(purpose => 
                                        `<span class="px-2 py-1 text-xs bg-gray-100 rounded">${purpose}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Data Retention Until</p>
                                <p class="text-sm font-medium">${new Date(customerData.dataManagement.dataRetentionUntil).toLocaleDateString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quiz Responses Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <span class="text-purple-500 mr-2">📝</span>
                            Quiz Responses
                        </h4>
                        <div class="max-h-64 overflow-y-auto">
                            ${formatQuizAnswers(customerData.quizData.answers)}
                        </div>
                    </div>
                    
                    <!-- AI Insights Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <span class="text-orange-500 mr-2">🤖</span>
                            AI Analysis & Insights
                        </h4>
                        ${formatAIInsights(customerData.quizData.insights)}
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div class="flex gap-2">
                            <button onclick="downloadCustomerData('${customerData.personalData.email}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                                Export Data
                            </button>
                            <button onclick="sendEmailToCustomer('${customerData.personalData.email}')" class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                                Send Email
                            </button>
                        </div>
                        <button onclick="closeModal()" class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }
        
        // Add search/filter functionality
        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => {
                // Search in available fields
                const searchableText = [
                    customer.id,
                    customer.consentId,
                    customer.hasEmail ? 'email' : '',
                    customer.hasName ? 'name' : '',
                    customer.hasZipCode ? 'zip' : '',
                    new Date(customer.createdAt).toLocaleDateString()
                ].join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm);
            });
            
            renderTable(filteredCustomers);
        }
        
        // Update renderTable to accept optional filtered list
        function renderTable(customersToShow = customers) {
            const tbody = document.getElementById('customerTable');
            
            if (customersToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No customers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = customersToShow.map(customer => `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 text-xs">${customer.id.substring(0, 8)}...</td>
                    <td class="py-2 text-xs">${customer.consentId.substring(0, 12)}...</td>
                    <td class="py-2">${customer.hasEmail ? '✓ Email' : ''}</td>
                    <td class="py-2">${customer.hasName ? '✓ Name' : ''}</td>
                    <td class="py-2">${customer.hasZipCode ? '✓ Zip' : ''}</td>
                    <td class="py-2 text-sm">${new Date(customer.createdAt).toLocaleDateString()}</td>
                    <td class="py-2">
                        <button onclick="viewDetails('${customer.consentId}')" class="text-blue-500 hover:text-blue-700 text-sm">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Add helper functions for actions
        function downloadCustomerData(email) {
            // In a real app, this would trigger a download
            alert(`Export data for ${email} - Feature coming soon!`);
        }
        
        function sendEmailToCustomer(email) {
            // In a real app, this would open email composer
            alert(`Send email to ${email} - Feature coming soon!`);
        }
        
        // Load customers on page load
        loadCustomers();
        
        // Refresh every 30 seconds
        setInterval(loadCustomers, 30000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionMatch - Professional Vision Assessment</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind with VisionMatch brand colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#3b82f6',
                        'primary-blue-dark': '#1e40af',
                        'text-dark': '#0f172a',
                        'text-medium': '#475569',
                        'text-light': '#64748b',
                        'bg-cream': '#fffef7'
                    },
                    fontFamily: {
                        'visionmatch': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Define initMap globally before Google Maps loads
        window.initMap = function() {
            console.log("Google Maps API loaded successfully");
            console.log("üî• QUIZ FILE LOADED - VERSION 2024-LATEST - CHANGES APPLIED");
            console.log("üîç DEBUG: Setting up quiz debugging...");
        };
        
        // Fallback for Google Maps API loading errors
        window.gm_authFailure = function() {
            console.warn("Google Maps API authentication failed");
        };
        
        // Handle Google Maps loading timeout
        setTimeout(function() {
            if (!window.google || !window.google.maps) {
                console.warn("Google Maps API failed to load within timeout");
            }
        }, 10000);
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwPLk8BhFMmAMWSAlKC3DOgPMNqL6BJXA&callback=initMap&libraries=places&v=weekly"></script>
    <style>
        :root {
            --scroll-hue: 220;
            --scroll-intensity: 0.5;
            --scroll-wave: 0.5;
            --mouse-x: 0.5;
            --mouse-y: 0.5;
            --mouse-hue: 30;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: 
                radial-gradient(ellipse 800px 600px at 15% 25%, rgba(255, 248, 220, 0.8) 0%, transparent 70%),
                radial-gradient(ellipse 700px 500px at 80% 60%, rgba(250, 245, 195, 0.6) 0%, transparent 65%),
                radial-gradient(ellipse 900px 700px at 45% 85%, rgba(255, 251, 235, 0.7) 0%, transparent 60%),
                radial-gradient(ellipse 600px 400px at 90% 20%, rgba(147, 197, 253, 0.15) 0%, transparent 50%),
                linear-gradient(135deg, 
                    hsl(55, 80%, 98%) 0%,
                    hsl(50, 70%, 97%) 20%,
                    hsl(45, 60%, 96%) 40%,
                    hsl(40, 55%, 95%) 60%,
                    hsl(50, 50%, 97%) 80%,
                    hsl(60, 70%, 99%) 100%);
            min-height: 100vh;
            color: #1f2937;
            position: relative;
            overflow-x: hidden;
            transition: background 0.6s ease;
        }

        /* Dynamic organic gradient background that changes on scroll */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: 
                radial-gradient(ellipse 1200px 800px at calc(20% + var(--mouse-x) * 30%) calc(30% + var(--mouse-y) * 20%), 
                    hsla(calc(220 + var(--mouse-hue)), 70%, 85%, calc(0.15 + var(--scroll-intensity) * 0.1)) 0%, 
                    transparent 65%),
                radial-gradient(ellipse 1000px 600px at calc(10% + var(--scroll-wave) * 15%) calc(15% + var(--scroll-intensity) * 10%), 
                    hsla(50, 80%, 88%, calc(0.2 + var(--scroll-wave) * 0.08)) 0%, 
                    transparent 50%),
                radial-gradient(ellipse 1400px 900px at calc(85% - var(--scroll-intensity) * 20%) calc(75% + var(--scroll-wave) * 15%), 
                    hsla(45, 75%, 90%, calc(0.18 + var(--scroll-intensity) * 0.1)) 0%, 
                    transparent 60%),
                radial-gradient(ellipse 800px 500px at calc(95% - var(--mouse-x) * 25%) calc(25% + var(--mouse-y) * 30%), 
                    hsla(210, 60%, 92%, calc(0.12 + var(--scroll-wave) * 0.06)) 0%, 
                    transparent 45%),
                conic-gradient(from calc(var(--scroll-intensity) * 360deg) at calc(60% + var(--scroll-wave) * 20%) calc(40% + var(--scroll-intensity) * 30%), 
                    hsla(55, 60%, 94%, 0.08) 0deg,
                    hsla(220, 50%, 90%, 0.06) 90deg,
                    hsla(50, 70%, 92%, 0.1) 180deg,
                    hsla(210, 60%, 88%, 0.05) 270deg,
                    hsla(55, 60%, 94%, 0.08) 360deg);
            opacity: calc(0.6 + var(--scroll-intensity) * 0.3);
            pointer-events: none;
            z-index: 0;
            transition: opacity 0.4s ease;
            animation: organicFlow 40s ease-in-out infinite;
        }

        /* Enhanced organic texture overlay */
        body::after {
            content: '';
            position: fixed;
            top: -5%;
            left: -5%;
            width: 110%;
            height: 110%;
            opacity: 0.3;
            background-image: 
                radial-gradient(ellipse 600px 400px at 20% 20%, rgba(255, 248, 220, 0.6) 0%, transparent 50%),
                radial-gradient(ellipse 800px 600px at 80% 75%, rgba(250, 245, 195, 0.5) 0%, transparent 45%),
                radial-gradient(ellipse 500px 300px at 40% 90%, rgba(147, 197, 253, 0.2) 0%, transparent 40%),
                radial-gradient(ellipse 700px 450px at 90% 10%, rgba(191, 219, 254, 0.25) 0%, transparent 42%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 800 800' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='organicGrain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='8' stitchTiles='stitch'/%3E%3CfeColorMatrix values='1 0.95 0.85 0 0.05 0.95 0.9 0.8 0 0.03 0.85 0.8 0.7 0 0.02 0 0 0 0.18 0'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='20'/%3E%3CfeGaussianBlur stdDeviation='1'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23organicGrain)' fill='rgba(255,248,220,0.12)'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 600 600' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='fluidGlass'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.4' numOctaves='6' stitchTiles='stitch'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='15'/%3E%3CfeGaussianBlur stdDeviation='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23fluidGlass)' fill='rgba(255,255,255,0.2)'/%3E%3C/svg%3E");
            background-size: 400px 400px, 500px 500px, 350px 350px, 300px 300px, 200px 200px, 250px 250px;
            background-position: 0% 0%, 100% 100%, 50% 50%, 25% 75%, 0% 0%, 75% 25%;
            mix-blend-mode: multiply;
            pointer-events: none;
            z-index: 1;
            animation: organicFlow 35s ease-in-out infinite;
        }

        @keyframes organicFlow {
            0%, 100% { 
                background-position: 0% 0%, 100% 100%, 50% 50%, 25% 75%, 0% 0%, 75% 25%;
                transform: scale(1) rotate(0deg);
            }
            16% { 
                background-position: 12% 8%, 88% 92%, 48% 52%, 28% 72%, 4% 2%, 78% 22%;
                transform: scale(1.02) rotate(0.3deg);
            }
            33% { 
                background-position: 25% 15%, 75% 85%, 45% 55%, 32% 68%, 8% 6%, 82% 18%;
                transform: scale(1.008) rotate(-0.2deg);
            }
            50% { 
                background-position: 40% 25%, 60% 75%, 40% 60%, 38% 62%, 15% 12%, 88% 12%;
                transform: scale(1.025) rotate(0.15deg);
            }
            66% { 
                background-position: 55% 35%, 45% 65%, 35% 65%, 42% 58%, 22% 18%, 92% 8%;
                transform: scale(1.015) rotate(-0.1deg);
            }
            83% { 
                background-position: 68% 42%, 32% 58%, 30% 70%, 48% 52%, 28% 22%, 96% 4%;
                transform: scale(1.01) rotate(0.05deg);
            }
        }

        /* Clean liquid glass navigation */
        .nav {
            position: fixed;
            top: 1.5rem;
            left: 2rem;
            right: 2rem;
            z-index: 50;
            backdrop-filter: blur(20px) saturate(160%);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0.55) 100%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1.5rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 2px 12px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .nav:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.08),
                0 4px 18px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-image {
            height: 32px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .logo-text {
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: -0.01em;
            background: linear-gradient(135deg, #1f2937, #374151);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #3b82f6;
        }

        .nav-btn {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 1.5rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.25);
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }

        /* Educational Tip Styles - Always Highlighted & Bigger */
        .education-panel {
            background: linear-gradient(135deg, rgba(236, 242, 255, 0.9), rgba(255, 247, 237, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 5;
            transition: all 0.3s ease;
            cursor: pointer;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            overflow: hidden;
        }

        .education-panel:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.25);
        }

        /* Always highlighted text - bigger fonts */
        .education-panel p {
            color: #1e40af;
            font-weight: 500;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .education-panel .education-icon {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.05);
            transition: all 0.3s ease;
            width: 2rem;
            height: 2rem;
            font-size: 0.9rem;
        }

        .education-panel .education-title {
            color: #1e40af;
            font-weight: 600;
            font-size: 1rem;
        }

        /* Always highlight emotional words */
        .education-content {
            position: relative;
            animation: subtle-glow 3s ease-in-out infinite;
        }

        @keyframes subtle-glow {
            0%, 100% { text-shadow: 0 0 8px rgba(59, 130, 246, 0.4); }
            50% { text-shadow: 0 0 12px rgba(59, 130, 246, 0.6), 0 0 18px rgba(255, 215, 0, 0.4); }
        }

        /* Always show colorful top border */
        .education-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #f59e0b);
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .education-panel:hover::before {
            opacity: 1;
        }

        .education-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .education-icon {
            width: 1.5rem;
            height: 1.5rem;
            background: rgba(107, 114, 128, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .education-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b7280;
            margin: 0;
        }

        .education-content {
            color: #1e40af;
            line-height: 1.6;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .education-content p {
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .education-content p:last-child {
            margin-bottom: 0;
        }

        .education-highlight {
            background: rgba(107, 114, 128, 0.05);
            border-left: 2px solid rgba(107, 114, 128, 0.2);
            padding: 0.75rem 1rem;
            margin: 0.75rem 0;
            border-radius: 0 0.25rem 0.25rem 0;
            font-weight: 400;
            font-size: 0.8rem;
        }

        .education-benefits {
            list-style: none;
            margin: 0.75rem 0;
            padding-left: 1rem;
        }

        .education-benefit {
            position: relative;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .education-benefit::before {
            content: '‚Ä¢';
            position: absolute;
            left: -0.75rem;
            color: #9ca3af;
        }

        .subscription-highlight {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.05));
            border-left: 3px solid #3b82f6;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: #1e40af;
        }

        .subscription-highlight strong {
            color: #1e40af;
            font-weight: 600;
        }

        /* Intro screen enhancements */
        .intro-screen {
            animation: fadeInUp 0.8s ease-out;
        }

        .intro-features-card {
            transition: all 0.3s ease;
            cursor: default;
        }

        .intro-features-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }



        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
                transform: scale(1.05);
            }
        }

        /* Liquid glass question container */
        .question-container {
            backdrop-filter: blur(20px) saturate(160%);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0.55) 100%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 2px 12px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-self: start;
        }

        .question-container:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.08),
                0 4px 18px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .quiz-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0.5rem 2rem 2rem 2rem;
        }

        .quiz-main {
            min-height: 600px;
        }

        .quiz-sidebar {
            position: sticky;
            top: 120px;
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .progress-section {
            background: rgba(248, 250, 252, 0.4);
            border: 1px solid rgba(209, 213, 219, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .progress-header {
            font-size: 0.8rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .section-progress {
            margin-bottom: 1rem;
        }

        .section-progress:last-child {
            margin-bottom: 0;
        }

        .section-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(209, 213, 219, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .quiz-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
                max-width: 800px;
                padding: 0.25rem 1.5rem 1.5rem 1.5rem;
            }
            
            .quiz-sidebar {
                position: static;
                order: -1;
                gap: 1rem;
            }

            .question-container {
                padding: 1.5rem;
            }

            .progress-section {
                padding: 0.75rem;
            }

            .progress-header {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .nav {
                top: 1rem;
                left: 1rem;
                right: 1rem;
                padding: 0.75rem 1.5rem;
            }
            .nav-links {
                display: none;
            }
            
            .logo-text {
                font-size: 0.95rem;
            }

            .quiz-layout {
                padding: 1rem;
                gap: 1.5rem;
            }

            .education-panel {
                padding: 1rem;
                margin: 1rem 0;
                font-size: 0.8rem;
            }

            .education-title {
                font-size: 0.9rem;
            }

            .education-content {
                font-size: 0.85rem;
            }

            .education-content p {
                font-size: 0.85rem;
            }

            .education-benefit {
                font-size: 0.75rem;
            }

            .subscription-highlight {
                margin-top: 0.75rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            /* Mobile intro screen adjustments */
            .intro-screen {
                min-height: 400px;
                padding: 1rem;
            }

            .intro-screen h1 {
                font-size: 2.5rem !important;
                line-height: 1.1;
            }

            .intro-screen p {
                font-size: 1.1rem !important;
            }

            .intro-features-card {
                padding: 0.75rem;
            }

            .question-container {
                padding: 1.25rem;
                min-height: 300px;
            }

            .detail-section {
                font-size: 0.8rem;
            }

            .detail-section .detail-prompt {
                font-size: 0.75rem;
            }

            .detail-section .detail-question {
                font-size: 0.8rem;
            }
        }

        /* Quiz-specific styles */
        .visionmatch-gradient {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
        }
        
        .visionmatch-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px) saturate(160%);
            border-radius: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 2px 12px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .visionmatch-button {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border: none;
            border-radius: 1.5rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .visionmatch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            border-radius: 8px;
        }
        
        .visionmatch-brand {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pulse-once {
            animation: pulse 0.6s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body class="font-visionmatch">
    <nav class="nav">
        <div class="nav-container">
            <div class="logo">
                <svg class="logo-image" viewBox="0 0 80 48" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="circle1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#67e8f9;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="circle2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#1e40af;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle cx="20" cy="24" r="16" fill="url(#circle1)" opacity="0.9"/>
                    <circle cx="36" cy="24" r="16" fill="url(#circle2)" opacity="0.8"/>
                </svg>
                <div class="logo-text">VISIONMATCH</div>
            </div>
            <ul class="nav-links">
                <li><a href="index.html#how-it-works">How It Works</a></li>
                <li><a href="index.html#included">What's Included</a></li>
                <li><a href="index.html">Assessment</a></li>
            </ul>
            <a href="index.html" class="nav-btn">Back to Home</a>
        </div>
    </nav>
    <div id="root"></div>

    <script type="text/javascript">
        const { useState } = React;
        
        // SVG icon components with VisionMatch styling
        const ChevronRight = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'm9 18 6-6-6-6' }));
        const ChevronLeft = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'm15 18-6-6 6-6' }));
        const Eye = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z' }), React.createElement('circle', { cx: 12, cy: 12, r: 3 }));
        const Glasses = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('circle', { cx: 6, cy: 15, r: 4 }), React.createElement('circle', { cx: 18, cy: 15, r: 4 }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'm6 11-2-2 1.5-1.5a2 2 0 0 1 1.414-.586H8.5m6 0h1.586a2 2 0 0 1 1.414.586L19 9l-2 2M10 15h4' }));
        const Sun = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('circle', { cx: 12, cy: 12, r: 4 }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 6.34l-1.41-1.41M19.07 19.07l-1.41-1.41' }));
        const Sparkles = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z' }));
        const MapPin = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 11a3 3 0 11-6 0 3 3 0 016 0z' }));
        const Clock = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('circle', { cx: 12, cy: 12, r: 10 }), React.createElement('polyline', { points: '12,6 12,12 16,14' }));
        const Phone = ({ className }) => React.createElement('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z' }));

        const GlassesFinderWizard = () => {
            console.log('GlassesFinderWizard component initializing');
            const [currentStep, setCurrentStep] = useState(0);
            const [answers, setAnswers] = useState({});
            const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);
            const [aiInsights, setAiInsights] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [showSectionComplete, setShowSectionComplete] = useState(false);
            const [completedSectionData, setCompletedSectionData] = useState(null);
            const [hasBookedExam, setHasBookedExam] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [selectedDate, setSelectedDate] = useState(null);
            const [availableTimes, setAvailableTimes] = useState([]);
            const [userZipCode, setUserZipCode] = useState('');
            const [userName, setUserName] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [resultStep, setResultStep] = useState('transition');
            const [selectedOptician, setSelectedOptician] = useState(null);
            const [userPhone, setUserPhone] = useState('');
            const [showAllBrands, setShowAllBrands] = useState(false);
            const [expandedDetails, setExpandedDetails] = useState({});
            const [detailAnswers, setDetailAnswers] = useState({});

            const questions = [
                {
                    type: 'single',
                    section: "What You Have",
                    question: "Do you currently wear prescription glasses or lenses?",
                    options: ["Yes, I wear glasses", "Yes, I wear both glasses and contact lenses", "No, but I think I need them", "No, and I don't think I need them"],
                    textField: {
                        question: "Tell us about your personal vision needs and specific concerns:",
                        placeholder: "e.g., trouble seeing at night, eye strain from computers, difficulty reading small text, headaches, dry eyes, glare sensitivity...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'single',
                    section: "What You Have",
                    question: "Give us more details on your current setup - How many pairs of glasses do you regularly use, including sunglasses?",
                    options: ["One", "Two", "Three or more"],
                    textField: {
                        question: "Give us more details on your current eyewear setup:",
                        placeholder: "e.g., I have reading glasses from 2019, use contacts most days but wear glasses for computer work, my prescription sunglasses are scratched...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'multiple',
                    section: "What You Have",
                    question: "What glasses do you own?",
                    options: ["Single vision", "Progressive", "Single vision sunglasses", "Progressive sunglasses", "Plain sunglasses"],
                    textField: {
                        question: "Care to give us more details on your current eyewear setup?",
                        placeholder: "e.g., prescription strength, when you got them, how often you wear them, any issues or preferences...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'multi-step',
                    section: "What You Have",
                    question: "Tell us about your main pair of glasses",
                    steps: [
                        {
                            question: "Where did you buy your main pair of glasses?",
                            type: 'single',
                            options: ["Alain Afflelou", "Multi√≥pticas", "General √ìptica", "√ìptica 2000", "Cottet", "√ìptica Universitaria", "Visionlab", "Local optician", "Online store", "Department store", "I don't remember", "Other"],
                            textField: {
                                question: "Please specify where:",
                                placeholder: "e.g., specific store name, online retailer, etc.",
                                showWhen: "Other"
                            }
                        },
                        {
                            question: "What brand are your main glasses?",
                            type: 'single',
                            options: ["Ray-Ban", "Oakley", "Tom Ford", "Oliver Peoples", "Lindberg", "Silhouette", "I don't know", "Other brand"],
                            textField: {
                                question: "Please specify the brand:",
                                placeholder: "e.g., Persol, Dior, local brand name, etc.",
                                showWhen: "Other brand"
                            }
                        },
                        {
                            question: "Why did you choose these specific frames?",
                            type: 'multiple',
                            options: ["Optician recommended", "Liked the style", "Good price", "Comfortable fit", "Brand reputation", "Previous experience", "Only option", "Friend recommended", "Other"],
                            textField: {
                                question: "Tell us more about why you chose these frames:",
                                placeholder: "e.g., they matched my face shape, needed something professional for work, had a prescription change and needed new frames quickly...",
                                showWhen: "Other"
                            }
                        }
                    ]
                },
                {
                    type: 'multi-step',
                    section: "What You Have",
                    question: "Tell us about your glasses history",
                    steps: [
                        {
                            question: "When did you buy your current glasses?",
                            type: 'single',
                            options: ["Less than 1 year", "1-2 years", "2-3 years", "3+ years"],
                            fullWidth: true
                        },
                        {
                            question: "What prompted your last glasses update?",
                            type: 'multiple',
                            options: ["Prescription changed", "Glasses broke/lost", "Wanted new style", "Eye exam recommendation", "Visited optician", "Still using old glasses", "Other"],
                            fullWidth: true,
                            textField: {
                                question: "Can you tell us what prompted your last glasses update?",
                                placeholder: "e.g., prescription gets stronger each year, stayed stable for years, got progressives recently...",
                                alwaysVisible: true
                            }
                        }
                    ]
                },
                {
                    type: 'single',
                    section: "What You Have",
                    question: "When were your sunglasses last updated?",
                    options: ["Less than 1 year", "1-2 years", "2-3 years", "3+ years", "I don't have prescription sunglasses"],
                    conditional: (answers) => {
                        // Show this question only if user has prescription sunglasses (progressive or single vision)
                        const question3Answers = answers[3] || [];
                        console.log('Sunglasses conditional - answers[3]:', question3Answers, 'Type:', typeof question3Answers, 'Is array:', Array.isArray(question3Answers));
                        if (!Array.isArray(question3Answers)) {
                            return false;
                        }
                        return question3Answers.includes("Single vision sunglasses") || question3Answers.includes("Progressive sunglasses");
                    },
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "What's your main concern with sunglasses?",
                            options: ["Need prescription sunglasses", "Current ones aren't dark enough", "Don't fit well", "Scratch too easily", "Want polarized lenses", "Happy with current ones"]
                        },
                        textField: {
                            question: "Describe your sunglasses needs:",
                            placeholder: "e.g., spend lots of time driving, need them for sports, mostly for fashion, glare is a big issue..."
                        }
                    }
                },
                {
                    type: 'multiple',
                    section: "What You Have",
                    question: "Do you have any of the following issues with any of your glasses?",
                    options: ["Fit isn't perfect", "Lenses are scratched", "I don't like the style anymore", "My prescription needs updating", "They're uncomfortable", "Need backup/additional pairs", "Want better vision for specific activities", "Need computer/blue light glasses", "Want prescription sunglasses", "No issues with my glasses"],
                    textField: {
                        question: "Tell us more about your issues with your current glasses:",
                        placeholder: "e.g., my reading glasses aren't strong enough for computer work, frames are too heavy, want prescription sunglasses...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'multiple',
                    section: "What You Have",
                    question: "What do you mostly use your glasses for?",
                    options: ["I always wear glasses", "Everyday wear", "Screen/office work", "Driving", "Sports or outdoors", "Reading", "Fashion", "Sunglasses"],
                    textField: {
                        question: "Tell us more about your glasses usage:",
                        placeholder: "e.g., need reading glasses at work but wear distance glasses, sunglasses aren't strong enough, switch between multiple pairs...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'celebration',
                    title: "We're getting to know you!",
                    subtitle: "Now let's get to know a bit more about you.",
                    progress: "You're halfway there"
                },
                {
                    type: 'multi-step',
                    section: "What You Need",
                    question: "What do you usually do in your free time?",
                    steps: [
                        {
                            question: "What are your main activities?",
                            type: 'multiple',
                            options: ["Sports", "Outdoor", "Reading", "Watch shows", "Gaming", "Other"],
                            fullWidth: true,
                            textField: {
                                question: "Please specify your other activities:",
                                placeholder: "e.g., creative arts, music, crafts, volunteer work, social activities...",
                                showWhen: "Other"
                            }
                        },
                        {
                            question: "Any specific activities you'd like to mention?",
                            type: 'multiple',
                            options: [], // Will be populated dynamically based on step 1
                            fullWidth: true,
                            gridLayout: true,
                            conditionalOptions: {
                                "Sports": ["Running/jogging", "Gym/fitness", "Team sports (football, basketball, etc.)", "Tennis/racquet sports", "Swimming", "Cycling", "Golf", "Martial arts", "Yoga/pilates", "Climbing/mountaineering", "Winter sports", "Water sports", "Other sports"],
                                "Outdoor": ["Hiking/walking", "Camping", "Fishing/hunting", "Gardening", "Photography", "Bird watching", "Beach activities", "Picnics/BBQs", "Adventure sports", "Nature exploration", "Outdoor festivals", "Other outdoor activities"],
                                "Reading": ["Fiction books", "Non-fiction/educational", "Magazines/newspapers", "E-books/digital reading", "Audiobooks", "Comics/graphic novels", "Professional/work reading", "Research/studying", "Book clubs", "Other reading"],
                                "Watch shows": ["Movies/cinema", "TV series/streaming", "Documentaries", "Sports broadcasts", "News programs", "YouTube/online videos", "Live performances/theater", "Gaming streams", "Educational content", "Other viewing"],
                                "Gaming": ["Video games (console)", "PC gaming", "Mobile gaming", "Board games", "Card games", "Online multiplayer", "Retro gaming", "Gaming tournaments", "Game development", "Other gaming"],
                                "Other": ["Creative arts (painting, drawing, crafts)", "Music (playing instruments, composing)", "Photography/videography", "Cooking/baking", "Gardening/landscaping", "Home improvement/DIY", "Volunteer work", "Social activities/events", "Learning/education", "Travel/exploration", "Collecting hobbies", "Technology/programming", "Other activities"]
                            },
                            textField: {
                                question: "Tell us about your special activities or spare time:",
                                placeholder: "e.g., playing piano, photography, hiking, cooking gourmet meals, gaming tournaments, woodworking, gardening...",
                                alwaysVisible: true
                            }
                        }
                    ]
                },
                {
                    type: 'single',
                    section: "What You Need",
                    question: "How many hours per day are you in front of a screen?",
                    options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "6-8 hours", "More than 8 hours"],
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "What type of screens do you use most?",
                            options: ["Computer/laptop", "Smartphone", "Tablet", "TV", "Gaming console", "Multiple devices throughout the day"]
                        },
                        textField: {
                            question: "Tell us about your screen usage patterns:",
                            placeholder: "e.g., work from home on computer all day, constantly checking phone, evening TV watching, gaming sessions..."
                        }
                    }
                },
                {
                    type: 'single',
                    section: "What You Need",
                    question: "Do you ever avoid wearing glasses because they get in the way of your activities?",
                    options: ["Yes", "Sometimes", "No"],
                    textField: {
                        question: "Tell us more about when you avoid wearing glasses:",
                        placeholder: "e.g., during exercise, while cooking, when going out socially, at work...",
                        alwaysVisible: true
                    },
                    conditional: (answers) => {
                        const wearsGlasses = answers[0] && answers[0].includes('glasses');
                        const uses = answers[6] || [];
                        const freeTime = answers[8] || [];
                        const doesSports = uses.includes("Sports or outdoors") || freeTime.includes("Exercise or play sports") || freeTime.includes("Spend time outdoors");
                        return wearsGlasses && doesSports;
                    },
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "Which activities are most affected by your glasses?",
                            options: ["Sports/exercise", "Cooking", "Outdoor activities", "Dancing/socializing", "Working with hands", "None specifically"]
                        },
                        textField: {
                            question: "Describe when glasses become inconvenient:",
                            placeholder: "e.g., slip during sports, fog up when cooking, uncomfortable with headphones, hard to wear with safety equipment..."
                        }
                    }
                },
                {
                    type: 'multi-step',
                    section: "What You Need",
                    question: "Tell us about your working environment",
                    steps: [
                        {
                            question: "What best describes your primary work environment?",
                            type: 'single',
                            options: ["Office", "Indoors", "Outdoors", "Mixed environments"],
                            fullWidth: true
                        },
                        {
                            question: "Which specific environment best matches your work?",
                            type: 'multiple',
                            options: [], // Will be populated dynamically based on step 1
                            fullWidth: true,
                            conditionalOptions: {
                                "Office": ["Open office", "Private office", "Home office", "Co-working space", "Conference rooms"],
                                "Indoors": ["Retail/customer service", "Education/teaching", "Healthcare", "Manufacturing", "Restaurant/hospitality"],
                                "Outdoors": ["Construction", "Landscaping", "Delivery/transport", "Sports/recreation", "Agriculture"],
                                "Mixed environments": ["Field sales", "Consulting", "Hybrid remote/office", "Management", "Travel-based work"]
                            },
                            textField: {
                                question: "Tell us more about your work environment:",
                                placeholder: "e.g., open office with bright LED lights, home office by a window, outdoor construction work, laboratory with specialized lighting...",
                                alwaysVisible: true
                            }
                        }
                    ]
                },
                {
                    type: 'multiple',
                    section: "What You Need",
                    question: "Do you ever experience any of the following?",
                    options: ["Headaches related to eyesight", "Tired eyes", "Glare sensitivity", "Eye strain at screen", "Dry eyes", "None of these", "Other"],
                    textField: {
                        question: "Describe your eye comfort issues:",
                        placeholder: "e.g., headaches after 2+ hours on computer, eyes water in bright light, tired eyes by evening, dry eyes with contacts...",
                        alwaysVisible: true
                    }
                },
                {
                    type: 'slider',
                    section: "What You Need",
                    question: "Are you happy with your current glasses?",
                    sliderLabels: ["Not happy at all", "Very happy"],
                    sliderDefault: 50,
                    conditional: () => false, // Skip this question
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "What would make you happier with your glasses?",
                            options: ["Better fit/comfort", "Updated prescription", "More attractive frames", "Different lens type", "Additional pairs", "Nothing, they're great"]
                        },
                        textField: {
                            question: "What do you like/dislike about your current glasses?",
                            placeholder: "e.g., frames are too heavy, prescription isn't quite right, love the style but lenses scratch, need backup pair..."
                        }
                    }
                },
                {
                    type: 'slider',
                    section: "What You Need",
                    question: "Do you think your current setup covers all your needs?",
                    sliderLabels: ["Not at all", "Perfectly"],
                    sliderDefault: 50,
                    conditional: () => false, // Skip this question
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "What situations are not covered by your current glasses?",
                            options: ["Computer work", "Reading small print", "Driving at night", "Bright sunlight", "Sports/activities", "Distance viewing", "All situations covered"]
                        },
                        textField: {
                            question: "Describe what's missing from your vision setup:",
                            placeholder: "e.g., need prescription sunglasses for driving, reading glasses for close work, computer glasses for work..."
                        }
                    }
                },
                {
                    type: 'slider',
                    section: "What You Need",
                    question: "What is important for you in glasses?",
                    sliderLabels: ["Price", "Style/Brand"],
                    sliderDefault: 50,
                    conditional: () => false,
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "Which factors are most important when choosing glasses?",
                            options: ["Affordability", "Designer brands", "Comfort/fit", "Lens quality", "Durability", "Latest fashion", "Professional appearance"]
                        },
                        textField: {
                            question: "Tell us about your priorities for glasses:",
                            placeholder: "e.g., need something professional for work but fun for weekends, budget is key but want quality lenses, brand matters for confidence..."
                        }
                    }
                },
                {
                    type: 'multi-step',
                    section: "What You Need",
                    question: "What style do you like the most?",
                    steps: [
                        {
                            question: "What style do you like the most?",
                            type: 'multiple',
                            options: ["Classic and timeless (clean lines, traditional shapes)", "Modern and minimalist (sleek, simple, contemporary)", "Bold and statement-making (eye-catching, unique designs)", "Sporty and functional (durable, active lifestyle)", "Luxury and premium (high-end materials, designer brands)", "Trendy and fashion-forward (latest styles, cutting-edge)", "Professional and conservative (business-appropriate, understated)", "Creative and artistic (unique, expressive, unconventional)", "I care about the fit, not the style", "No specific preference"],
                            fullWidth: true
                        },
                        {
                            question: "Which brands match your style preferences?",
                            type: 'multiple',
                            options: ["Ray-Ban", "General √ìptica", "Multi√≥pticas", "Alain Afflelou", "Local independent opticians", "No brand preference"], // Default fallback options
                            gridLayout: true,
                            conditionalOptions: {
                                "Classic and timeless": ["Ray-Ban", "Persol", "Oliver Peoples", "Silhouette", "Moscot", "Local independent opticians", "General √ìptica", "Multi√≥pticas", "No brand preference"],
                                "Modern and minimalist": ["Lindberg", "Mykita", "ic! berlin", "Ace & Tate", "Cubitts", "General √ìptica", "Multi√≥pticas", "No brand preference"],
                                "Bold and statement-making": ["Tom Ford", "Dior", "Gucci", "Versace", "Etnia Barcelona", "Theo", "Local independent opticians", "No brand preference"],
                                "Sporty and functional": ["Oakley", "Nike", "Maui Jim", "Revo", "Adidas", "Under Armour", "General √ìptica", "Multi√≥pticas"],
                                "Luxury and premium": ["Tom Ford", "Cartier", "Chanel", "Oliver Peoples", "Dita", "Lindberg", "Local independent opticians", "No brand preference"],
                                "Trendy and fashion-forward": ["Gucci", "Saint Laurent", "Prada", "Garrett Leight", "Kirk & Kirk", "Ace & Tate", "Local independent opticians", "No brand preference"],
                                "Professional and conservative": ["Ray-Ban", "Oliver Peoples", "Silhouette", "Lindberg", "General √ìptica", "Multi√≥pticas", "Local independent opticians", "No brand preference"],
                                "Creative and artistic": ["Mykita", "Theo", "L.A. Eyeworks", "Etnia Barcelona", "Local artisan frames", "Boutique brands", "Local independent opticians", "No brand preference"],
                                "I care about the fit, not the style": ["Focus on comfort and fit", "Local independent opticians", "General √ìptica", "Multi√≥pticas", "Quality over brand", "No brand preference"],
                                "No specific preference": ["Ray-Ban", "General √ìptica", "Multi√≥pticas", "Alain Afflelou", "Local independent opticians", "Focus on fit and comfort", "No brand preference"]
                            },
                            textField: {
                                question: "Tell us more about your personal style and what you're really looking for:",
                                placeholder: "e.g., I want to feel confident in meetings, need something that matches my personality, want frames that make me look approachable, prefer something that works with my face shape and lifestyle...",
                                alwaysVisible: true
                            }
                        }
                    ]
                },
                {
                    type: 'multiple',
                    section: "What You Need",
                    question: "What matters most to you in sunglasses?",
                    options: ["UV protection", "Style and fashion", "Durability", "Comfort for all-day wear", "Clear vision while driving", "Sports performance", "Price/value", "Brand prestige", "Other"],
                    textField: {
                        question: "Any specific sunglasses preferences or experiences?",
                        placeholder: "e.g., need polarized lenses for driving, prefer wraparound style for sports, had issues with cheap sunglasses breaking...",
                        alwaysVisible: true
                    },
                    details: {
                        prompt: "If you give us more details, we will be able to provide better insights.",
                        multipleChoice: {
                            question: "What specific features do you need in sunglasses?",
                            options: ["Polarized lenses", "Prescription sunglasses", "Wraparound style", "Lightweight frames", "Interchangeable lenses", "Anti-reflective coating", "Photochromic lenses", "None specifically"]
                        },
                        textField: {
                            question: "Tell us about your sunglasses usage and preferences:",
                            placeholder: "e.g., need them for daily driving, wear during sports activities, prefer designer brands, have issues with current pair slipping..."
                        }
                    }
                }
            ];

            // Educational content generator - simplified static content
            const getEducationalContent = (questionIndex, currentAnswers) => {
                const question = questions[questionIndex];
                if (!question || question.type === 'intro') return null;

                const educationalContent = {
                    // First question - intro content
                    0: {
                        icon: 'üéØ',
                        title: 'Ready to see what you\'ve been missing?',
                        content: `
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; font-size: 1.1em;">üí° <strong>Ever notice this?</strong></p>
                                <p style="margin: 8px 0 0 0;">Your phone screen is crystal clear at 12 inches, but those same glasses make your computer screen at 24 inches feel blurry by afternoon!</p>
                            </div>
                            <p style="margin-bottom: 20px;">Let's find your missing pieces and finally get you seeing life in HD üé¨</p>
                            <div class="education-benefits">
                                <div class="education-benefit">‚ö° Lightning-fast analysis</div>
                                <div class="education-benefit">üéØ Scary-accurate recommendations</div>
                                <div class="education-benefit">‚ú® "Why didn't I do this sooner" moments</div>
                            </div>
                        `
                    },
                    // Question about current prescription glasses
                    1: {
                        icon: 'üëÅÔ∏è',
                        title: 'Your eyes are shapeshifters!',
                        content: `
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;"><strong>üåÖ Morning:</strong> Fresh eyes, sharp focus</p>
                                <p style="margin: 4px 0;"><strong>‚òÄÔ∏è Afternoon:</strong> Getting tired, focus drifting</p>
                                <p style="margin: 4px 0 0 0;"><strong>üåô Evening:</strong> Exhausted, everything's fuzzy</p>
                            </div>
                            <p style="margin: 0; font-style: italic;">One pair trying to do it all? No wonder you're squinting by 3pm!</p>
                        `
                    },
                    // Question about number of glasses
                    2: {
                        icon: 'ü§Ø',
                        title: 'The game-changing truth',
                        content: `
                            <div style="text-align: center; padding: 16px; background: #e0e7ff; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; font-size: 1.5em; font-weight: bold; color: #4f46e5;">üò≤ Wait, what?</p>
                                <p style="margin: 4px 0 0 0;">You mean I don't have to choose between seeing my book OR my computer clearly?</p>
                            </div>
                            <p style="margin: 0;">üî® You wouldn't use a hammer to paint a wall, right?<br/>
                            So why use distance glasses for computer work? ü§î</p>
                        `
                    },
                    // Question about frame purchase details (new Q3)
                    3: {
                        icon: 'üò§',
                        title: 'The comfort conspiracy',
                        content: `
                            <div style="background: #fee2e2; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; font-size: 1.2em;"><strong>That familiar feeling:</strong></p>
                                <p style="margin: 8px 0 0 0;">Red marks on your nose bridge after 2 hours üòñ</p>
                                <p style="margin: 4px 0 0 0;">Glasses sliding down every 10 minutes üôÑ</p>
                                <p style="margin: 4px 0 0 0;">Ears aching by end of day üò´</p>
                            </div>
                            <p style="margin: 0;">That's not "just how glasses feel" - that's <strong>wrong measurements!</strong><br/>
                            <span style="font-size: 0.9em;">Professional fitting = all-day comfort üòå</span></p>
                        `
                    },
                    // Screen time question
                    10: {
                        icon: 'üíª',
                        title: 'Screen time reality check',
                        content: `
                            <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üò≥ <strong>You literally forget to blink!</strong></p>
                                <p style="margin: 8px 0 0 0;">üìâ Blink rate drops from 22 to just 7 per minute = Sahara desert eyes</p>
                            </div>
                            <p style="margin: 0;"><strong>The deadly combo:</strong><br/>
                            üîµ Blue light bombing<br/>
                            üëì Wrong prescription distance<br/>
                            üò¥ = Why you're dead by 3pm</p>
                        `
                    },
                    // Symptoms question
                    11: {
                        icon: 'üö®',
                        title: 'Your eyes are SCREAMING at you',
                        content: `
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; font-size: 1.1em;">üß† <strong>That 3pm headache...</strong></p>
                                <p style="margin: 8px 0 0 0;">The one that starts behind your eyes and spreads to your temples?</p>
                                <p style="margin: 4px 0 0 0;">Happens every workday but mysteriously disappears on vacation? ü§î</p>
                            </div>
                            <p style="margin: 0;">Your brain is literally <em>working overtime</em> to compensate for vision issues.<br/>
                            <span style="font-size: 0.9em;">No wonder you're exhausted! üò´</span></p>
                        `
                    },
                    // Question about what glasses they own (now Q4)
                    4: {
                        icon: 'üß©',
                        title: 'So close, yet so far!',
                        content: `
                            <div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">You've got <strong style="font-size: 1.5em; color: #ef4444;">distance glasses</strong></p>
                                <p style="margin: 8px 0 0 0;">But you're using them to read your phone üòÖ</p>
                                <p style="margin: 4px 0 0 0;">And wondering why Instagram gives you a headache!</p>
                            </div>
                            <p style="margin: 0;">It's like having a smartphone but no charger...<br/>
                            <em>technically</em> works, but you're missing out! üì±üòÖ</p>
                        `
                    },
                    // Question about prescription updates (now Q5)
                    5: {
                        icon: 'üëÄ',
                        title: 'Your eyes are evolving!',
                        content: `
                            <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üîÑ <strong>Remember when:</strong></p>
                                <p style="margin: 8px 0 0 0;">Your glasses used to feel perfect all day?</p>
                                <p style="margin: 4px 0 0 0;">Now by evening, everything's a little... soft around the edges? üòë</p>
                            </div>
                            <p style="margin: 0;">Wearing 3-year-old prescription? üò¨<br/>
                            That's like using an iPhone 6 in 2024...<br/>
                            <em>It works, but WHY suffer?</em></p>
                        `
                    },
                    // Question about sunglasses updates (now Q6)
                    6: {
                        icon: 'üòé',
                        title: 'The squint tax is REAL',
                        content: `
                            <div style="background: #fff7ed; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; font-size: 1.1em;">‚ö†Ô∏è <strong>Research shows:</strong></p>
                                <p style="margin: 8px 0 0 0;">Up to 20% of cataracts worldwide are caused by UV overexposure!</p>
                            </div>
                            <p style="margin: 0;"><strong>Prescription sunglasses aren't a luxury...</strong><br/>
                            They're an investment in not looking like a raisin at 50! üçá<br/>
                            <span style="font-size: 0.9em;">(Plus, you know, preventing cataracts and stuff)</span></p>
                        `
                    },
                    // Question about glasses usage (now Q7)
                    7: {
                        icon: 'üìê',
                        title: 'The distance dilemma',
                        content: `
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;"><strong>Your eyes' workload:</strong></p>
                                <p style="margin: 8px 0 0 0;">üìñ Reading: 16 inches<br/>
                                üíª Computer: 24 inches<br/>
                                üì∫ TV: 10+ feet</p>
                            </div>
                            <p style="margin: 0;">One pair doing triple duty? üèãÔ∏è<br/>
                            <strong>No wonder your eyes want to quit by lunch!</strong></p>
                        `
                    },
                    // New question about changing glasses needs (Q8)
                    8: {
                        icon: 'üîÑ',
                        title: 'The focus marathon',
                        content: `
                            <div style="text-align: center; padding: 16px; background: #fef3c7; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; font-size: 1.2em; font-weight: bold; color: #f59e0b;">The daily eye workout:</p>
                                <p style="margin: 4px 0 0 0;">Phone (12") ‚Üí Computer (24") ‚Üí TV (10 feet) ‚Üí Phone again</p>
                                <p style="margin: 4px 0 0 0;">All day. Every day. No wonder they're tired! üò©</p>
                            </div>
                            <p style="margin: 0;">Your poor eye muscles = Olympic athletes<br/>
                            ...except they never signed up for this! üòÖ<br/>
                            <em>(That burning sensation? They're filing a complaint)</em></p>
                        `
                    },
                    // Free time activities (Q10)
                    9: {
                        icon: 'üèÜ',
                        title: 'Level up your game!',
                        content: `
                            <div style="background: #e0e7ff; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">‚ö° <strong>You know that moment...</strong></p>
                                <p style="margin: 8px 0 0 0;">When you're playing tennis and lose the ball in the sun? üéæ</p>
                                <p style="margin: 4px 0 0 0;">Or your glasses fog up during a run and you're basically blind? üèÉ‚Äç‚ôÇÔ∏è</p>
                            </div>
                            <p style="margin: 0;">Still using regular glasses for sports? üò¨<br/>
                            That's like playing tennis with a ping pong paddle...<br/>
                            <em>Sure, it's possible, but why handicap yourself?</em></p>
                        `
                    },
                    // Screen time question (now Q11)
                    11: {
                        icon: 'üñ•Ô∏è',
                        title: 'Welcome to screen prison!',
                        content: `
                            <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üì±üíªüñ•Ô∏è <strong>Over 65% of adults experience digital eye strain!</strong></p>
                                <p style="margin: 8px 0 0 0;">Your eyes are working overtime in this digital world! üòµ</p>
                            </div>
                            <p style="margin: 0;"><strong>Computer glasses aren't "nice to have"...</strong><br/>
                            They're as essential as your laptop! üíº<br/>
                            <span style="font-size: 0.9em;">(Unless you enjoy feeling like a zombie by 2pm?)</span></p>
                        `
                    },
                    // Avoiding glasses question (now Q12)
                    12: {
                        icon: 'üöÄ',
                        title: 'Stop missing out on life!',
                        content: `
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üéâ <strong>What if you could:</strong></p>
                                <p style="margin: 8px 0 0 0;">üèä Actually see underwater lane lines clearly<br/>
                                üö¥ Stop squinting into the wind on your bike<br/>
                                üèÄ Never worry about your glasses flying off mid-game</p>
                            </div>
                            <p style="margin: 0;">Still avoiding activities because of glasses? üòî<br/>
                            <strong>That's 2010 thinking!</strong> Time for an upgrade! üéØ</p>
                        `
                    },
                    // Symptoms question (now Q13)
                    13: {
                        icon: 'üå™Ô∏è',
                        title: 'The domino effect',
                        content: `
                            <div style="background: #fee2e2; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üòµ <strong>Eye strain starts a chain reaction:</strong></p>
                                <p style="margin: 8px 0 0 0;">Tired eyes ‚Üí stress hormones ‚Üí bad sleep ‚Üí worse eyes üîÑ</p>
                            </div>
                            <p style="margin: 0;"><strong>It's not "just tired eyes"...</strong><br/>
                            It's your whole body saying "HELP!" üÜò<br/>
                            <span style="font-size: 0.9em;">(That 3am wake-up? Yep, blame your eyes)</span></p>
                        `
                    },
                    // Working environment question (now Q14)
                    14: {
                        icon: 'üí°',
                        title: 'Office eyes vs. home eyes',
                        content: `
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üè¢ <strong>Office life:</strong></p>
                                <p style="margin: 8px 0 0 0;">Fluorescent lights blasting from above ‚¨áÔ∏è</p>
                                <p style="margin: 4px 0 0 0;">Dim laptop screen staring back at you ‚¨ÜÔ∏è</p>
                                <p style="margin: 4px 0 0 0;">Your poor eyes trying to handle both = üòµ‚Äçüí´</p>
                            </div>
                            <p style="margin: 0;"><strong>Work glasses aren't just "computer glasses"...</strong><br/>
                            They're your productivity superpower! ü¶∏<br/>
                            <span style="font-size: 0.9em;">(Watch that 2pm slump disappear)</span></p>
                        `
                    },
                    
                    // Style preferences question (now Q16)
                    16: {
                        icon: 'üíñ',
                        title: 'Love your look = love your vision',
                        content: `
                            <div style="background: #fce7f3; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üòç <strong>We've all been there:</strong></p>
                                <p style="margin: 8px 0 0 0;">Avoiding photos because you hate your frames üì∑</p>
                                <p style="margin: 4px 0 0 0;">Taking them off for selfies (and squinting blind) ü§®</p>
                                <p style="margin: 4px 0 0 0;">Choosing contacts for dates even though they're uncomfortable üòò</p>
                            </div>
                            <p style="margin: 0;"><strong>"Just functional" frames? Boring!</strong><br/>
                            Life's too short for ugly glasses üé≠<br/>
                            <span style="font-size: 0.9em;">(Your face deserves better!)</span></p>
                        `
                    },
                    
                    // Sunglasses preferences question (now Q17)
                    17: {
                        icon: 'üï∂Ô∏è',
                        title: 'The UV truth bomb',
                        content: `
                            <div style="background: #fff7ed; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">‚ö†Ô∏è <strong>Research confirms:</strong></p>
                                <p style="margin: 8px 0 0 0;">UV damage to eyes is cumulative and irreversible<br/>
                                But you CAN'T see it happening! üëª</p>
                            </div>
                            <p style="margin: 0;"><strong>Good sunglasses = insurance policy for your eyes</strong><br/>
                            Future you will thank present you! üôè<br/>
                            <span style="font-size: 0.9em;">(Plus you'll look mysteriously cool)</span></p>
                        `
                    },
                    
                    // Final completion
                    18: {
                        icon: 'üéâ',
                        title: 'Your vision upgrade awaits!',
                        content: `
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #f0f9ff 100%); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; text-align: center; font-size: 1.1em;">üéØ <strong>We've cracked your vision code!</strong></p>
                                <p style="margin: 8px 0 0 0; text-align: center;">Ready to see what you've been missing? üëÄ‚ú®</p>
                            </div>
                            <p style="margin: 0; text-align: center;"><strong>Your personalized vision system is ready...</strong><br/>
                            <span style="font-size: 0.9em;">Let's make blurry, tired eyes a thing of the past! üöÄ</span></p>
                        `
                    },
                    
                    
                    // Question 15 - Happiness with current glasses
                    15: {
                        icon: 'üòä',
                        title: 'Honesty time!',
                        content: `
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">ü§î <strong>Here's the thing about "happy enough":</strong></p>
                                <p style="margin: 8px 0 0 0;">Most people accept vision compromises because they think that's just "how glasses work"</p>
                                <p style="margin: 8px 0 0 0;">But what if they could work better? ü§Ø</p>
                            </div>
                        `
                    },
                    
                    // Question 19 - Current needs coverage
                    19: {
                        icon: 'üï≥Ô∏è',
                        title: 'The honesty moment',
                        content: `
                            <div style="background: #e0e7ff; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üéØ <strong>Most people think their setup is "fine"...</strong></p>
                                <p style="margin: 8px 0 0 0;">Until they realize what they've been missing!</p>
                                <p style="margin: 4px 0 0 0;">Like using reading glasses for driving üòÖ</p>
                            </div>
                        `
                    },
                    
                    // Question 20 - Vision changes with age
                    20: {
                        icon: 'üìà',
                        title: 'Your eyes are time travelers',
                        content: `
                            <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">‚è∞ <strong>Remember when:</strong></p>
                                <p style="margin: 8px 0 0 0;">You could read restaurant menus in dim lighting?</p>
                                <p style="margin: 4px 0 0 0;">Thread a needle without squinting?</p>
                                <p style="margin: 4px 0 0 0;">Your eyes weren't tired by 9pm? üåÖ</p>
                            </div>
                        `
                    },
                    
                    // Question 21 - Free time activities
                    21: {
                        icon: 'üéØ',
                        title: 'Life beyond work!',
                        content: `
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üèÉ‚Äç‚ôÇÔ∏è <strong>Your hobbies deserve HD vision too!</strong></p>
                                <p style="margin: 8px 0 0 0;">Why settle for "good enough" when you're doing what you love?</p>
                                <p style="margin: 4px 0 0 0;">Perfect vision = perfect enjoyment ‚ú®</p>
                            </div>
                        `
                    },
                    
                    // Question 22 - Screen time hours
                    22: {
                        icon: 'üì±',
                        title: 'Welcome to the digital age',
                        content: `
                            <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üìä <strong>Fun fact:</strong> Average adult spends 7+ hours daily on screens</p>
                                <p style="margin: 8px 0 0 0;">That's like a full-time job for your eyes! üòµ‚Äçüí´</p>
                                <p style="margin: 4px 0 0 0;">No wonder they're begging for specialized help</p>
                            </div>
                        `
                    },
                    
                    // Question 23 - Activities avoided
                    23: {
                        icon: 'üö´',
                        title: 'Breaking free from limits',
                        content: `
                            <div style="background: #fee2e2; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üíî <strong>The saddest part:</strong></p>
                                <p style="margin: 8px 0 0 0;">Missing out on life because of glasses limitations</p>
                                <p style="margin: 4px 0 0 0;">But specialized eyewear can unlock everything! üîì</p>
                            </div>
                        `
                    },
                    
                    // Question 24 - Eye symptoms
                    24: {
                        icon: 'üòµ‚Äçüí´',
                        title: 'Your eyes are talking',
                        content: `
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üÜò <strong>Those "normal" symptoms?</strong></p>
                                <p style="margin: 8px 0 0 0;">They're actually your eyes' SOS signals!</p>
                                <p style="margin: 4px 0 0 0;">Dry, tired, burning = "Please help us!" üò¢</p>
                            </div>
                        `
                    },
                    
                    // Question 25 - Working environment
                    25: {
                        icon: 'üíº',
                        title: 'Your workplace vision reality',
                        content: `
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üè¢ <strong>Work-from-home vs office eyes:</strong></p>
                                <p style="margin: 8px 0 0 0;">Different lighting, different distances, different challenges</p>
                                <p style="margin: 4px 0 0 0;">One-size-fits-all glasses? Good luck! üòÖ</p>
                            </div>
                        `
                    },
                    
                    // Question 26 - Budget considerations
                    26: {
                        icon: 'üí∞',
                        title: 'Investment vs expense',
                        content: `
                            <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üí° <strong>Think about it:</strong></p>
                                <p style="margin: 8px 0 0 0;">You use your eyes 16+ hours daily</p>
                                <p style="margin: 4px 0 0 0;">That's more than your phone, car, or bed!</p>
                                <p style="margin: 4px 0 0 0;">Shouldn't they get the best tools? ü§î</p>
                            </div>
                        `
                    },
                    
                    // Question 27 - Style preferences
                    27: {
                        icon: '‚ú®',
                        title: 'Your face, your canvas',
                        content: `
                            <div style="background: #fce7f3; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üé® <strong>Style psychology is real:</strong></p>
                                <p style="margin: 8px 0 0 0;">When you love how you look, confidence soars</p>
                                <p style="margin: 4px 0 0 0;">When confidence soars, you wear glasses consistently</p>
                                <p style="margin: 4px 0 0 0;">Consistency = better vision health! üìà</p>
                            </div>
                        `
                    },
                    
                    // Question 28 - Sunglasses style
                    28: {
                        icon: 'üòé',
                        title: 'Sun protection with style',
                        content: `
                            <div style="background: #fff7ed; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0;">üï∂Ô∏è <strong>The sunglasses dilemma:</strong></p>
                                <p style="margin: 8px 0 0 0;">Regular sunglasses = can't see clearly</p>
                                <p style="margin: 4px 0 0 0;">No sunglasses = UV damage + squinting</p>
                                <p style="margin: 4px 0 0 0;">Prescription sunglasses = problem solved! ‚òÄÔ∏è</p>
                            </div>
                        `
                    },
                    
                    // Question 29 - Final question
                    29: {
                        icon: 'üèÅ',
                        title: 'The final piece',
                        content: `
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #ecfdf5 100%); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0; text-align: center;">üß© <strong>Every detail matters</strong></p>
                                <p style="margin: 8px 0 0 0; text-align: center;">This last piece completes your vision puzzle!</p>
                                <p style="margin: 4px 0 0 0; text-align: center;">Almost ready for your personalized recommendations! üéØ</p>
                            </div>
                        `
                    }
                };
                return educationalContent[questionIndex] || null;
            };

            const downloadResultsAsPDF = () => {
                try {
                    const content = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <h1 style="color: #3b82f6; text-align: center; margin-bottom: 30px;">Your Personalized Vision Plan</h1>
                            
                            <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h2 style="color: #1f2937; margin-bottom: 15px;">üìä Your Answers Summary</h2>
                                ${Object.entries(answers).map(([key, value]) => {
                                    const question = questions[parseInt(key)];
                                    if (!question) return '';
                                    return `<p><strong>${question.question}</strong><br/>${Array.isArray(value) ? value.join(', ') : value}</p>`;
                                }).join('')}
                            </div>
                            
                            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h2 style="color: #1f2937; margin-bottom: 15px;">üß† AI-Powered Insights</h2>
                                <div>${aiInsights.replace(/\n/g, '<br/>')}</div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #6b7280;">
                                <p>Generated by VisionMatch Vision Finder ‚Ä¢ ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;

                    const printWindow = window.open('', '_blank');
                    if (printWindow) {
                        printWindow.document.write(`
                            <html>
                                <head><title>Your Vision Plan</title></head>
                                <body>${content}</body>
                            </html>
                        `);
                        printWindow.document.close();
                        printWindow.print();
                    }
                } catch (error) {
                    alert('Download failed. Please try again or take a screenshot of your results.');
                }
            };

            const [personalitySummary, setPersonalitySummary] = useState("");
            const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);

            const generatePersonalitySummary = async () => {
                if (personalitySummary) return personalitySummary; // Return cached summary if already generated
                
                setIsGeneratingSummary(true);
                
                try {
                    // Collect relevant answers for personality analysis, especially text fields
                    const relevantAnswers = {
                        currentGlasses: answers[0],
                        glassesDetailsText: answers['0_text'], // Text field from Q1
                        glassesSetupText: answers['1_text'], // Text field from Q2
                        glassesTypesText: answers['2_text'], // Text field from Q3
                        glassesHistory: answers[4],
                        glassesHistoryText: answers[4]?.['1_text'], // Text from glasses history
                        issues: answers[6],
                        issuesText: answers['6_text'], // Text field from issues question
                        glassesUsage: answers[7],
                        glassesUsageText: answers['7_text'], // Text field from usage question
                        freeTimeActivities: answers[9]?.[0], // Step 1 of multi-step
                        freeTimeDetails: answers[9]?.['1_text'] // Text field from step 2
                    };

                    const prompt = `Based on their quiz answers, create a SHORT (1 sentence), funny, personal observation that shows you're paying attention to what they actually wrote. Focus especially on their free text responses. Be playful, witty, and insightful - NOT sales-y. Make them laugh or think "wow, they get me":

Current glasses: ${relevantAnswers.currentGlasses}
What they wrote about vision needs: "${relevantAnswers.glassesDetailsText}"
What they wrote about their setup: "${relevantAnswers.glassesSetupText}" 
What they wrote about their glasses types: "${relevantAnswers.glassesTypesText}"
Glasses history: ${JSON.stringify(relevantAnswers.glassesHistory)}
What they wrote about glasses history: "${relevantAnswers.glassesHistoryText}"
Issues with current glasses: ${relevantAnswers.issues}
What they wrote about their issues: "${relevantAnswers.issuesText}"
How they use glasses: ${relevantAnswers.glassesUsage}
What they wrote about usage: "${relevantAnswers.glassesUsageText}"
Free time activities: ${relevantAnswers.freeTimeActivities}
What they wrote about activities: "${relevantAnswers.freeTimeDetails}"

PAY SPECIAL ATTENTION to what they wrote in text fields - their specific details, complaints, activities. Pick up on quirky details or contradictions.

Examples of the playful, observational tone I want:
- If they wrote about gaming tournaments but have old glasses: "Gaming tournaments with 3-year-old glasses? That's like racing Formula 1 with bicycle brakes."
- If they mentioned photography but can't see clearly: "A photographer who can't see clearly - the irony is not lost on us."
- If they wrote about cooking but have scratched lenses: "Cooking with scratched lenses explains why the salt and sugar containers look identical."

Be FUNNY, OBSERVATIONAL, and pick up on their actual details. One sentence max. Don't sell anything.`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyBwPLk8BhFMmAMWSAlKC3DOgPMNqL6BJXA`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.8,
                                maxOutputTokens: 60
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Gemini API call failed');
                    }

                    const data = await response.json();
                    const summary = data.candidates[0].content.parts[0].text.trim();
                    setPersonalitySummary(summary);
                    setIsGeneratingSummary(false);
                    return summary;
                } catch (error) {
                    console.error('Error generating personality summary:', error);
                    setIsGeneratingSummary(false);
                    
                    // Fallback to simple summary if API fails
                    const fallback = "You're the type who actually reads the fine print on everything - including vision questionnaires apparently.";
                    setPersonalitySummary(fallback);
                    return fallback;
                }
            };

            const generateAIInsights = async () => {
                setIsGeneratingInsights(true);
                setLoadingProgress(0);
                
                const progressInterval = setInterval(() => {
                    setLoadingProgress(prev => {
                        if (prev >= 95) {
                            clearInterval(progressInterval);
                            return 95;
                        }
                        return prev + Math.random() * 15;
                    });
                }, 200);

                const timeoutId = setTimeout(() => {
                    console.log("AI request timed out, using fallback");
                    clearInterval(progressInterval);
                    setLoadingProgress(100);
                    setTimeout(() => {
                        setAiInsights(generatePersonalizedFallback());
                        setIsGeneratingInsights(false);
                    }, 500);
                }, 8000); // Increased timeout for retries
                
                const tryGeminiAPI = async (model, retryCount = 0) => {
                    try {
                        console.log(`ü§ñ Trying ${model} (attempt ${retryCount + 1})...`);
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=AIzaSyBwPLk8BhFMmAMWSAlKC3DOgPMNqL6BJXA`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: "You're a vision expert analyzing someone's current glasses setup and helping them optimize it. Based on their questionnaire, provide personalized recommendations for what to keep, what to change, and what to add.\n\n" +
                                            "Their answers: " + JSON.stringify(answers, null, 2) + "\n" +
                                            "Detail answers: " + JSON.stringify(detailAnswers, null, 2) + "\n\n" +
                                            "ANALYSIS FRAMEWORK:\n" +
                                            "1. Current Setup Analysis: What glasses they currently own and how satisfied they are\n" +
                                            "2. Usage Pattern Analysis: How they actually use their current glasses\n" +
                                            "3. Gap Analysis: What situations/activities aren't covered by current setup\n" +
                                            "4. Update/Upgrade Needs: Which current glasses need prescription updates or replacements\n" +
                                            "5. Addition Needs: What new glasses would complete their setup\n\n" +
                                            "RECOMMENDATION STRUCTURE:\n" +
                                            "1. KEEP: Which current glasses are working well and should be maintained\n" +
                                            "2. UPDATE/UPGRADE: Which current glasses need changes (new prescription, better lenses, etc.)\n" +
                                            "3. ADD: What new glasses are missing from their setup\n" +
                                            "4. OPTICIAN VISIT: Why they should visit our partner opticians\n\n" +
                                            "Focus on their CURRENT setup as the baseline and build recommendations from there. Be specific about what they currently have vs. what they need.\n\n" +
                                            "IMPORTANT: Only show what the end user should read, not you thought process! talk directly to them, be helpful and friendly. you are a seasoned eyewear professional.\n\n" +
                                            "Structure your response like this:\n\n" +
                                            "**Your Current Setup Analysis:** [Analyze what they currently have and how it's performing]\n\n" +
                                            "**What to Keep:** [Which current glasses are working well]\n\n" +
                                            "**What to Update/Upgrade:** [Current glasses that need changes - prescription updates, better lenses, etc.]\n\n" +
                                            "**What to Add:** [New glasses needed to complete their vision system]\n\n" +
                                            "**Next Steps:** [Why visiting our partner opticians will help them protect current frames they want to keep and get the new ones they need]"
                                    }]
                                }]
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`${response.status}: ${errorText}`);
                        }
                        
                        const data = await response.json();
                        console.log(`‚úÖ ${model} success!`, data);
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                            return data.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Invalid response format');
                        }
                        
                    } catch (error) {
                        console.log(`‚ùå ${model} failed (attempt ${retryCount + 1}):`, error.message);
                        
                        // If it's a 503 overload error and we have retries left
                        if (error.message.includes('503') && retryCount < 2) {
                            const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff: 1s, 2s, 4s
                            console.log(`‚è≥ Retrying ${model} in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return tryGeminiAPI(model, retryCount + 1);
                        }
                        
                        throw error;
                    }
                };
                
                try {
                    console.log("ü§ñ Starting Gemini AI analysis...");
                    console.log("User answers:", answers);
                    
                    let result;
                    
                    // Try Flash model first (faster)
                    try {
                        result = await tryGeminiAPI('gemini-1.5-flash');
                    } catch (flashError) {
                        console.log("üîÑ Flash model failed, trying Pro model...");
                        // Fallback to Pro model if Flash is overloaded
                        result = await tryGeminiAPI('gemini-1.5-pro');
                    }
                    
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    setLoadingProgress(100);
                    
                    setTimeout(() => {
                        setAiInsights(result);
                        setIsGeneratingInsights(false);
                        console.log("üéâ Real AI insights generated!");
                    }, 500);
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    console.log("üîÑ Both AI models failed, using intelligent fallback:", error.message);
                    setLoadingProgress(100);
                    
                    setTimeout(() => {
                        setAiInsights(generatePersonalizedFallback());
                        setIsGeneratingInsights(false);
                        console.log("‚úÖ Smart recommendations generated from your answers!");
                    }, 1000);
                }
            };

            const generatePersonalizedFallback = () => {
                // Helper function to find answers by question content
                const findAnswerByQuestion = (questionText) => {
                    for (let i = 0; i < questions.length; i++) {
                        if (questions[i].question && questions[i].question.toLowerCase().includes(questionText.toLowerCase())) {
                            return answers[i];
                        }
                    }
                    return null;
                };

                // Analyze current setup
                const wearsGlasses = findAnswerByQuestion('Do you currently wear prescription glasses');
                const currentGlasses = findAnswerByQuestion('What glasses do you own');
                const glassesCount = findAnswerByQuestion('How many pairs of glasses');
                const primaryUpdated = findAnswerByQuestion('Have your primary glasses been updated');
                const sunglassesUpdated = findAnswerByQuestion('Have your sunglasses been updated');
                const happyWithCurrent = findAnswerByQuestion('Are you happy with your current glasses');
                const setupCoversNeeds = findAnswerByQuestion('Do you think your current setup covers all your needs');
                const screenTime = findAnswerByQuestion('How many hours per day are you in front of a screen');
                const eyeSymptoms = findAnswerByQuestion('Do you ever experience any of the following');
                const activities = findAnswerByQuestion('Tell us about your specific activities');

                // Determine current status
                let currentSetupAnalysis = "Based on your responses, ";
                let keepRecommendations = [];
                let updateRecommendations = [];
                let addRecommendations = [];

                // Analyze what they currently have
                if (wearsGlasses && wearsGlasses.includes('glasses')) {
                    if (Array.isArray(currentGlasses)) {
                        if (currentGlasses.includes('Progressive')) {
                            currentSetupAnalysis += "you have progressive lenses which provide good all-distance vision. ";
                            if (primaryUpdated === 'Yes') {
                                keepRecommendations.push("Your progressive glasses - keep them as your primary daily wear since they're recently updated");
                            } else {
                                updateRecommendations.push("Your progressive glasses need a prescription update to ensure optimal vision");
                            }
                        }
                        if (currentGlasses.includes('Single vision')) {
                            currentSetupAnalysis += "you have single vision glasses for specific distances. ";
                            if (primaryUpdated === 'Yes') {
                                keepRecommendations.push("Your single vision glasses - maintain them for their specific purpose");
                            } else {
                                updateRecommendations.push("Your single vision glasses should be updated with your current prescription");
                            }
                        }
                        if (currentGlasses.includes('sunglasses')) {
                            if (sunglassesUpdated === 'Yes') {
                                keepRecommendations.push("Your prescription sunglasses - they're up to date and protecting your eyes well");
                            } else if (sunglassesUpdated === 'No') {
                                updateRecommendations.push("Your prescription sunglasses need updating to match your current vision needs");
                            }
                        }
                    }

                    // Check for missing sunglasses
                    if (!currentGlasses || !currentGlasses.some(g => g.includes('sunglasses'))) {
                        addRecommendations.push("Prescription sunglasses - essential for outdoor activities and driving comfort");
                    }
                } else {
                    currentSetupAnalysis += "you're ready to start your vision journey. ";
                    addRecommendations.push("Primary glasses for your daily vision needs");
                    addRecommendations.push("Prescription sunglasses for outdoor protection");
                }

                // Check for screen-related needs
                if (screenTime && (screenTime.includes('5‚Äì8') || screenTime.includes('More than 8'))) {
                    if (Array.isArray(eyeSymptoms) && eyeSymptoms.includes('Eye strain at screen')) {
                        addRecommendations.push("Computer glasses with blue light filtering - specifically for your extensive screen time");
                    }
                }

                // Check for activity-specific needs
                if (activities && activities.length > 10) {
                    if (activities.toLowerCase().includes('sport') || activities.toLowerCase().includes('exercise')) {
                        addRecommendations.push("Sports glasses with impact-resistant lenses for your active lifestyle");
                    }
                }

                // Format recommendations
                const keepSection = keepRecommendations.length > 0 ? 
                    `**What to Keep:**\n${keepRecommendations.map(rec => `‚Ä¢ ${rec}`).join('\n')}\n\n` : '';

                const updateSection = updateRecommendations.length > 0 ?
                    `**What to Update/Upgrade:**\n${updateRecommendations.map(rec => `‚Ä¢ ${rec}`).join('\n')}\n\n` : '';

                const addSection = addRecommendations.length > 0 ?
                    `**What to Add:**\n${addRecommendations.map(rec => `‚Ä¢ ${rec}`).join('\n')}\n\n` : '';

                const nextSteps = "**Next Steps:** Visit one of our 47 Barcelona partner opticians to protect your current frames with our coverage plan and get professionally fitted for your new glasses. They'll help you seamlessly integrate new eyewear into your routine while keeping what's already working for you.";
                
                return "**Your Current Setup Analysis:** " + currentSetupAnalysis + "Let's optimize what you have and fill the gaps.\n\n" + keepSection + updateSection + addSection + nextSteps;
            };

            const bookExamSlot = (slot) => {
                setSelectedSlot(slot);
                setHasBookedExam(true);
            };

            const renderBookingCalendar = () => {
                const today = new Date();

                const generateCalendarDays = () => {
                    const days = [];
                    let currentDate = new Date(today);
                    currentDate.setDate(today.getDate() + 1);
                    
                    while (days.length < 10) {
                        if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                            days.push(new Date(currentDate));
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    return days;
                };

                const generateTimeSlotsForDate = (date) => {
                    const times = [];
                    const startHour = 9;
                    const endHour = 17;
                    
                    for (let hour = startHour; hour <= endHour; hour++) {
                        if (hour === 13) continue;
                        
                        const time = new Date(date);
                        time.setHours(hour, 0, 0, 0);
                        
                        const isBooked = Math.random() < 0.3;
                        
                        times.push({
                            time: time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }),
                            datetime: time,
                            isBooked
                        });
                    }
                    return times;
                };

                const calendarDays = generateCalendarDays();

                const handleDateSelect = (date) => {
                    setSelectedDate(date);
                    setAvailableTimes(generateTimeSlotsForDate(date));
                };

                const selectTimeSlot = (time) => {
                    const slot = {
                        date: selectedDate?.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                        time: time.time,
                        datetime: time.datetime
                    };
                    bookExamSlot(slot);
                };
                
                return React.createElement('div', { className: "space-y-6" },
                    React.createElement('div', { className: "text-center" },
                        React.createElement('h3', { className: "text-2xl font-bold text-gray-800 mb-4" }, "üìÖ Book Your Eye Exam"),
                        React.createElement('p', { className: "text-gray-600 mb-6" },
                            "Schedule a comprehensive eye exam to get personalized recommendations from our certified opticians."
                        )
                    ),

                    React.createElement('div', { className: "visionmatch-card p-6 shadow-sm" },
                        React.createElement('h4', { className: "text-lg font-semibold text-gray-800 mb-4" }, "1. Enter Your Zip Code"),
                        React.createElement('div', { className: "max-w-md" },
                            React.createElement('input', {
                                type: "text",
                                value: userZipCode,
                                onChange: (e) => setUserZipCode(e.target.value.replace(/\D/g, '').slice(0, 5)),
                                placeholder: "Enter zip code (e.g., 28001)",
                                className: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg",
                                maxLength: 5
                            }),
                            React.createElement('p', { className: "text-sm text-gray-500 mt-2" }, "We'll find the closest certified opticians in your area")
                        )
                    ),

                    userZipCode.length >= 5 && React.createElement('div', { className: "visionmatch-card p-6 shadow-sm" },
                        React.createElement('h4', { className: "text-lg font-semibold text-gray-800 mb-4" }, "2. Select a Date"),
                        React.createElement('div', { className: "grid grid-cols-5 gap-3" },
                            calendarDays.map((day, index) =>
                                React.createElement('button', {
                                    key: index,
                                    onClick: () => handleDateSelect(day),
                                    className: `p-3 border rounded-lg text-center transition-all hover:border-blue-400 ${
                                        selectedDate?.toDateString() === day.toDateString()
                                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                                            : 'border-gray-200 hover:bg-gray-50'
                                    }`
                                },
                                    React.createElement('div', { className: "text-xs text-gray-500 font-medium" },
                                        day.toLocaleDateString('en-US', { weekday: 'short' })
                                    ),
                                    React.createElement('div', { className: "text-lg font-semibold" },
                                        day.getDate()
                                    ),
                                    React.createElement('div', { className: "text-xs text-gray-500" },
                                        day.toLocaleDateString('en-US', { month: 'short' })
                                    )
                                )
                            )
                        )
                    ),

                    selectedDate && userZipCode.length >= 5 && React.createElement('div', { className: "visionmatch-card p-6 shadow-sm" },
                        React.createElement('h4', { className: "text-lg font-semibold text-gray-800 mb-4" },
                            `3. Choose a Time for ${selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`
                        ),
                        React.createElement('div', { className: "grid grid-cols-3 md:grid-cols-4 gap-3" },
                            availableTimes.map((timeSlot, index) =>
                                React.createElement('button', {
                                    key: index,
                                    onClick: () => selectTimeSlot(timeSlot),
                                    disabled: timeSlot.isBooked,
                                    className: `p-3 rounded-lg font-medium transition-all ${
                                        timeSlot.isBooked
                                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200'
                                            : 'border border-blue-200 text-blue-700 hover:bg-blue-50 hover:border-blue-400'
                                    }`
                                },
                                    timeSlot.isBooked ? 
                                        React.createElement('div', { className: "flex flex-col items-center" },
                                            React.createElement('span', { className: "text-sm" }, timeSlot.time),
                                            React.createElement('span', { className: "text-xs" }, "Booked")
                                        ) : 
                                        timeSlot.time
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "text-center text-sm text-gray-500" },
                        React.createElement('p', null, "üí° All exams include comprehensive vision testing and personalized glasses recommendations")
                    )
                );
            };

            const renderOpticiansList = () => {
                const mockStores = [
                    { 
                        name: "Optica Nova", 
                        distance: "550m", 
                        specialty: "Fast service & great progressive lens fittings", 
                        phone: "+34 912 345 678",
                        address: "Calle Gran Via 45, Madrid",
                    },
                    { 
                        name: "CentroVisi√≥n", 
                        distance: "1.1km", 
                        specialty: "Specialists in sports and sunglasses", 
                        phone: "+34 912 345 679",
                        address: "Plaza Mayor 12, Madrid", 
                    },
                    { 
                        name: "√ìptica Bassol", 
                        distance: "2.3km", 
                        specialty: "Premium frames & lens upgrade support", 
                        phone: "+34 912 345 680",
                        address: "Paseo de la Castellana 89, Madrid",
                    }
                ];

                return React.createElement('div', { className: "space-y-6" },
                    React.createElement('div', { className: "bg-green-50 rounded-xl p-4 border border-green-200" },
                        React.createElement('div', { className: "flex items-center space-x-3" },
                            React.createElement('div', { className: "w-10 h-10 bg-green-500 rounded-full flex items-center justify-center" },
                                React.createElement('svg', { className: "w-6 h-6 text-white", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M5 13l4 4L19 7" })
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('h4', { className: "font-semibold text-green-800" }, "Exam Booked Successfully!"),
                                React.createElement('p', { className: "text-sm text-green-700" },
                                    `${selectedSlot?.date} at ${selectedSlot?.time} in ${userZipCode} - Confirmation details sent to your email`
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "visionmatch-card p-6 shadow-lg" },
                        React.createElement('h3', { className: "text-xl font-semibold text-gray-800 mb-4 flex items-center" },
                            React.createElement(MapPin, { className: "w-5 h-5 mr-2 text-primary-blue" }),
                            "Your Closest Certified Opticians"
                        ),
                        React.createElement('div', { className: "space-y-4" },
                            mockStores.map((store, index) =>
                                React.createElement('div', { key: index, className: "p-4 bg-gray-50 rounded-xl border border-gray-100 hover:border-blue-300 transition-colors" },
                                    React.createElement('div', { className: "flex justify-between items-start mb-2" },
                                        React.createElement('h4', { className: "font-semibold text-gray-800" }, store.name),
                                        React.createElement('span', { className: "text-sm text-gray-500 bg-white px-2 py-1 rounded-full" }, store.distance)
                                    ),
                                    React.createElement('p', { className: "text-gray-600 text-sm mb-1" }, store.specialty),
                                    React.createElement('p', { className: "text-gray-500 text-xs mb-3" }, store.address),
                                    React.createElement('div', { className: "flex space-x-3" },
                                        React.createElement('button', { className: "flex-1 visionmatch-button py-2 px-4 rounded-lg font-medium transition-colors" },
                                            "Get Directions"
                                        ),
                                        React.createElement('button', { className: "flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg hover:border-gray-400 transition-colors" },
                                            React.createElement(Phone, { className: "w-4 h-4" })
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "visionmatch-card p-6 shadow-lg" },
                        React.createElement('h3', { className: "text-xl font-semibold text-gray-800 mb-4" }, "üìç Store Locations Map"),
                        React.createElement('div', { 
                            id: "opticians-map", 
                            className: "rounded-lg h-80 border border-gray-300",
                            style: { minHeight: "320px" }
                        }),
                        
                        React.createElement('div', { className: "mt-4 bg-gray-50 rounded-lg p-4" },
                            React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                React.createElement('h5', { className: "font-semibold text-gray-800" }, "Nearby Locations"),
                                React.createElement('span', { className: "text-sm text-gray-500" }, `Based on zip code: ${userZipCode || 'Not provided'}`)
                            ),
                            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                                mockStores.map((store, index) =>
                                    React.createElement('div', { key: index, className: "flex items-center space-x-3" },
                                        React.createElement('div', { 
                                            className: `w-6 h-6 rounded-full flex items-center justify-center text-white text-sm font-bold ${
                                                index === 0 ? 'bg-red-500' : index === 1 ? 'bg-blue-500' : 'bg-green-500'
                                            }`
                                        }, index + 1),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: "font-medium text-gray-800 text-sm" }, store.name),
                                            React.createElement('div', { className: "text-gray-500 text-xs" }, store.distance + " away")
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
            };

            const updateAnswer = (questionNum, value) => {
                setAnswers(prev => ({
                    ...prev,
                    [questionNum]: value
                }));
            };

            const isAnswered = () => {
                if (currentStep === 0) return true;
                if (currentStep >= questions.length) return true;
                
                const answer = answers[currentStep];
                const question = questions[currentStep];
                
                if (question?.type === 'multiple' || question?.type === 'brand-selector') {
                    return Array.isArray(answer) && answer.length > 0;
                }
                
                if (question?.type === 'multi-step') {
                    // For multi-step, check if all required steps are answered
                    if (!answer || typeof answer !== 'object') return false;
                    for (let i = 0; i < question.steps.length; i++) {
                        // Check if the step answer exists
                        if (answer[i] === undefined || answer[i] === null || answer[i] === '') {
                            return false;
                        }
                        // For text type steps, we don't require them to be filled
                        if (question.steps[i].type === 'text') {
                            continue;
                        }
                    }
                    return true;
                }
                
                if (question?.type === 'slider') {
                    return true;
                }
                
                if (question?.type === 'text') {
                    return true;
                }
                
                return answer !== undefined && answer !== null && answer !== '';
            };

            const getProgress = () => {
                const totalEffective = questions.filter((q, index) => index > 0 && (!q.conditional || q.conditional(answers) || answers[index] !== undefined)).length;
                const completedSteps = Object.keys(answers).filter(key => parseInt(key) > 0 && parseInt(key) <= currentStep).length;
                return (completedSteps / totalEffective) * 100;
            };

            const getSectionProgress = () => {
                const sections = [
                    { name: "What You Have", start: 1, end: 6 },
                    { name: "What You Need", start: 7, end: 16 }
                ];

                return sections.map((section) => {
                    let progress = 0;
                    if (currentStep < section.start) {
                        progress = 0;
                    } else if (currentStep > section.end) {
                        progress = 100;
                    } else {
                        const sectionProgress = (currentStep - section.start + 1) / (section.end - section.start + 1);
                        progress = sectionProgress * 100;
                    }
                    
                    return {
                        ...section,
                        progress,
                        isActive: currentStep >= section.start && currentStep <= section.end,
                        isComplete: currentStep > section.end
                    };
                });
            };

            const getSectionColor = (section) => {
                switch (section) {
                    case "Professional Vision Assessment": return "visionmatch-gradient";
                    case "What You Have": return "visionmatch-gradient";
                    case "What You Need": return "visionmatch-gradient";
                    default: return "visionmatch-gradient";
                }
            };

            const getSectionIcon = (section) => {
                switch (section) {
                    case "Let's Get Started": return Sparkles;
                    case "What You Have": return Glasses;
                    case "What You Need": return Eye;
                    default: return Sparkles;
                }
            };

            const getSectionInsights = (sectionName, answers) => {
                const generateDynamicInsight = (section) => {
                    // Helper function to find answer by question text
                    const findAnswerByQuestion = (questionText) => {
                        const questionIndex = questions.findIndex(q => q.question && q.question.includes(questionText));
                        return questionIndex !== -1 ? answers[questionIndex] : null;
                    };
                    
                    // Dynamic insights based on user responses
                    
                    switch(section) {
                        case "Current Setup":
                            // Find answers by question content instead of hardcoded indices
                            const wearsGlasses = findAnswerByQuestion('Do you currently wear glasses or lenses?');
                            const glassesCount = findAnswerByQuestion('How many pairs of glasses do you regularly use?');
                            const satisfaction = findAnswerByQuestion('Are you happy with your current setup?');
                            const glassesUse = findAnswerByQuestion('What do you mostly use your glasses for?') || [];
                            

                            
                            // New user insights
                            if (!wearsGlasses || (!wearsGlasses.includes('glasses') && !wearsGlasses.includes('both'))) {
                                const contactsOnly = wearsGlasses && wearsGlasses.includes('contacts');
                                if (contactsOnly) {
                                    return "üëÅÔ∏è Contacts-only users often discover glasses as their secret weapon for eye comfort and style versatility!";
                                }
                                return "üåü Perfect timing! Many people avoid glasses until problems develop - you're being proactive about your vision health.";
                            }

                            // Experienced user insights with more variety
                            const veryHappy = satisfaction && satisfaction.includes("Very happy");
                            const notHappy = satisfaction && satisfaction.includes("Not at all");
                            const multipleUses = Array.isArray(glassesUse) && glassesUse.length >= 3;
                            const screenWork = Array.isArray(glassesUse) && glassesUse.includes("Screen/office work");
                            const driving = Array.isArray(glassesUse) && glassesUse.includes("Driving");
                            const reading = Array.isArray(glassesUse) && glassesUse.includes("Reading");
                            const sports = Array.isArray(glassesUse) && glassesUse.includes("Sports or outdoors");

                            if (notHappy && glassesCount === "Just one") {
                                return "üéØ Your frustration makes perfect sense - one pair trying to handle everything rarely works perfectly for any task!";
                            }
                            
                            if (veryHappy && glassesCount === "Just one") {
                                return "üëè Amazing that one pair works so well for you! Let's see if we can make your vision experience even better.";
                            }

                            if (glassesCount === "More than two" && veryHappy) {
                                return "üèÜ You've discovered the vision optimization secret - multiple specialized pairs for peak performance!";
                            }

                            if (screenWork && driving && reading) {
                                return "üìä Screen + driving + reading? Your eyes work harder than most - specialized lenses for each activity can be life-changing!";
                            }
                            
                            if (sports && screenWork) {
                                return "‚ö° Digital work AND active lifestyle? You need glasses that can keep up with your dynamic routine!";
                            }

                            if (multipleUses && glassesCount === "Just one") {
                                return "üîÑ Your diverse activities deserve diverse optical solutions - it's like having one tool for every job!";
                            }

                            return "üíé Every vision setup is unique - let's optimize yours for maximum comfort and performance!";
                            
                        case "Lens Comfort & Eye Experience":
                            const screenTime = findAnswerByQuestion('How many hours per day are you in front of a screen?');
                            const symptoms = findAnswerByQuestion('Do you ever experience any of the following?') || [];
                            const lensType = findAnswerByQuestion('What type of lenses do you have today?');
                            const lensUpdated = findAnswerByQuestion('Have your lenses been updated in the past 2 years?');
                            

                            
                            // Enhanced symptom analysis
                            const hasEyeStrain = Array.isArray(symptoms) && symptoms.includes("Eye strain at screen");
                            const hasHeadaches = Array.isArray(symptoms) && symptoms.includes("Headaches");
                            const hasTiredEyes = Array.isArray(symptoms) && symptoms.includes("Tired eyes");
                            const hasDryEyes = Array.isArray(symptoms) && symptoms.includes("Dry eyes");
                            const hasBlurryVision = Array.isArray(symptoms) && symptoms.includes("Blurry vision");
                            const noSymptoms = Array.isArray(symptoms) && symptoms.includes("None of these");
                            const symptomCount = Array.isArray(symptoms) ? symptoms.filter(s => s !== "None of these").length : 0;

                            // Heavy screen users with multiple symptoms
                            if (screenTime === "More than 8 hours" && symptomCount >= 3) {
                                return "üö® Multiple symptoms + 8+ hours screens = your eyes are working overtime! Blue light filtering and proper breaks can transform your day.";
                            }

                            // Progressive lens computer struggles
                            if (lensType === "Progressive (multifocal)" && hasEyeStrain && screenTime !== "Less than 2 hours") {
                                return "üñ•Ô∏è Progressive lenses + computer work = neck strain and eye fatigue. Dedicated computer glasses are a game-changer!";
                            }

                            // Outdated prescription red flags
                            if (lensUpdated === "No" && (hasBlurryVision || hasHeadaches)) {
                                return "üìÖ Blurry vision or headaches with an old prescription? Your eyes are literally asking for an update!";
                            }

                            // Classic digital eye strain combo
                            if (hasEyeStrain && hasTiredEyes && screenTime !== "Less than 2 hours") {
                                return "üíª Eye strain + tired eyes = textbook digital fatigue. Anti-reflective coatings and blue light filters work wonders!";
                            }

                            // Dry eyes insight
                            if (hasDryEyes && screenTime === "More than 8 hours") {
                                return "üíß Extended screen time reduces your blink rate by 60%! Specialized lens coatings can help maintain eye moisture.";
                            }

                            // Headache analysis
                            if (hasHeadaches && !hasEyeStrain && lensType !== "I don't wear glasses") {
                                return "üß† Headaches without eye strain often mean your prescription needs fine-tuning - small changes, big relief!";
                            }

                            // No symptoms celebration with variety
                            if (noSymptoms && screenTime === "More than 8 hours") {
                                return "üéâ No eye symptoms despite heavy screen use? You've got excellent visual stamina - let's keep it that way!";
                            }
                            if (noSymptoms) {
                                return "‚ú® Symptom-free vision is a gift! Our goal is to optimize what's already working well for you.";
                            }

                            // Moderate users
                            if (screenTime === "4-6 hours" && symptomCount === 1) {
                                return "‚öñÔ∏è One symptom with moderate screen time? Catching issues early prevents them from becoming chronic problems.";
                            }

                            return "üîç Your symptom pattern reveals exactly where we can optimize your visual comfort - precision solutions ahead!";
                            
                        case "Lifestyle & Vision Needs":
                            const freeTime = findAnswerByQuestion('What do you usually do in your free time?') || [];
                            const drivingIssues = findAnswerByQuestion('Do you have issues with your current glasses while driving?');
                            const avoidGlasses = findAnswerByQuestion('Do you ever avoid wearing glasses because they get in the way?');
                            const activities = findAnswerByQuestion('Tell us about your specific activities and hobbies');
                            

                            
                            // Detailed activity analysis
                            const doesSports = Array.isArray(freeTime) && freeTime.includes("Exercise or play sports");
                            const doesOutdoors = Array.isArray(freeTime) && freeTime.includes("Spend time outdoors");
                            const doesReading = Array.isArray(freeTime) && freeTime.includes("Read/watch shows");
                            const doesCreative = Array.isArray(freeTime) && freeTime.includes("Create (music, art, crafts)");
                            const doesTravel = Array.isArray(freeTime) && freeTime.includes("Travel");
                            const doesSocial = Array.isArray(freeTime) && freeTime.includes("Socialize with friends/family");
                            const activityCount = Array.isArray(freeTime) ? freeTime.length : 0;

                            // Sports + avoids glasses = major insight
                            if (doesSports && avoidGlasses === "Yes") {
                                return "‚ö° Avoiding glasses during sports? You're missing out on enhanced performance, safety, and confidence - sport-specific eyewear changes everything!";
                            }

                            // Night driving struggles
                            if (drivingIssues && drivingIssues.includes("Yes, but only at night")) {
                                return "üåô Night driving troubles are incredibly common! Anti-reflective coatings reduce glare by up to 99% - like turning on high-def vision.";
                            }

                            // All driving issues
                            if (drivingIssues && drivingIssues.includes("Yes, all the time")) {
                                return "üöó Constant driving issues suggest your current glasses aren't optimized for distance vision - time for driving-specific lenses!";
                            }

                            // Creative + reading combo
                            if (doesCreative && doesReading) {
                                return "üé® Art + reading = your eyes constantly shift between detail work and relaxed viewing. Progressive lenses or task-specific pairs are perfect!";
                            }

                            // Outdoor enthusiasts
                            if (doesOutdoors && doesSports) {
                                return "üèûÔ∏è Outdoor sports combo? UV protection and impact resistance aren't just nice-to-have - they're essential for your active lifestyle!";
                            }

                            // Travel insights
                            if (doesTravel && activityCount >= 3) {
                                return "‚úàÔ∏è Multi-activity traveler detected! Versatile photochromic lenses adapt to any destination - from beach to mountain to city.";
                            }

                            // Social butterflies
                            if (doesSocial && avoidGlasses === "Yes") {
                                return "üë• Social person who avoids glasses? The right frames actually enhance your confidence and become a style statement!";
                            }

                            // Highly active people
                            if (activityCount >= 4) {
                                return "üéØ Wow, you're incredibly active! Your diverse lifestyle deserves equally diverse optical solutions - each activity has unique visual demands.";
                            }

                            // Detailed activity descriptions
                            if (activities && activities.length > 100) {
                                return "üìù Your detailed activity description shows how much vision matters to your life - let's make sure it's optimized for everything you love!";
                            }

                            // Low-key lifestyle
                            if (activityCount <= 2 && doesReading) {
                                return "üìö Focused lifestyle with reading emphasis? Comfort lenses with blue light filtering and anti-fatigue features are your best friends.";
                            }

                            return "üåü Your unique lifestyle pattern is exactly what we need to create the perfect vision solution - no generic recommendations here!";
                            
                                                case "Sun, Style & Self-Expression":
    
                            const stylePreference = findAnswerByQuestion('What is important for you in glasses?');
                            const brandPreference = findAnswerByQuestion('Do you prefer specific brands or styles?') || [];
                            
 
                            
                            // Enhanced style and sun protection analysis
                            const wantsRxSunglasses = prescriptionSunglasses === "No, but I'd like to";
                            const hasRxSunglasses = prescriptionSunglasses === "Yes";
                            const noRxSunglasses = prescriptionSunglasses === "No";
                            const styleImportant = Array.isArray(stylePreference) && stylePreference.includes("Style and looks");
                            const comfortImportant = Array.isArray(stylePreference) && stylePreference.includes("Comfort");
                            const durabilityImportant = Array.isArray(stylePreference) && stylePreference.includes("Durability");
                            const priceImportant = Array.isArray(stylePreference) && stylePreference.includes("Price/value");
                            const hasLuxuryBrands = Array.isArray(brandPreference) && (brandPreference.includes("Dita") || brandPreference.includes("Lindberg") || brandPreference.includes("Silhouette"));
                            const hasAccessibleBrands = Array.isArray(brandPreference) && (brandPreference.includes("General √ìptica") || brandPreference.includes("Multi√≥pticas"));

                            // Prescription sunglasses insights
                            if (wantsRxSunglasses && styleImportant) {
                                return "üï∂Ô∏è Style-conscious person wanting prescription sunglasses? You're about to discover the ultimate fusion of fashion and function!";
                            }
                            
                            if (wantsRxSunglasses && Array.isArray(stylePreference) && stylePreference.length >= 2) {
                                return "‚òÄÔ∏è Multiple priorities + wanting prescription sunglasses = perfect timing! UV protection with clear vision is life-changing.";
                            }

                            if (hasRxSunglasses && styleImportant) {
                                return "üëì Already rocking prescription sunglasses with style focus? You understand that functional doesn't mean boring!";
                            }

                            if (noRxSunglasses && !styleImportant) {
                                return "üåû No prescription sunglasses and style isn't your focus? You're missing the functional benefits - clear vision outdoors is transformative!";
                            }

                            // Style priority insights
                            if (styleImportant && hasLuxuryBrands) {
                                return "üíé High-end style preference detected! Luxury frames are investments in both vision quality and personal expression.";
                            }

                            if (styleImportant && comfortImportant) {
                                return "‚ú® Style + comfort combo? Smart approach - beautiful frames that disappear on your face are the holy grail of eyewear!";
                            }

                            // Value-focused insights
                            if (priceImportant && hasAccessibleBrands) {
                                return "üí∞ Value-focused with accessible brands? Smart strategy - quality doesn't require premium prices when you choose wisely!";
                            }

                            if (priceImportant && durabilityImportant) {
                                return "üèóÔ∏è Price + durability focus? You understand true value - well-made frames cost less per year than cheap ones that break!";
                            }

                            // Comfort prioritizers
                            if (comfortImportant && !styleImportant) {
                                return "üòå Comfort above all? Lightweight materials and perfect fits transform glasses from burden to blessing - function first!";
                            }

                            // Multi-priority insights
                            if (styleImportant && durabilityImportant && comfortImportant) {
                                return "üéØ Style + durability + comfort? You want it all, and premium materials like titanium can deliver exactly that!";
                            }

                            // Brand-agnostic insights
                            if (Array.isArray(brandPreference) && brandPreference.includes("No preference, I'm open to suggestions")) {
                                return "üîç Open to suggestions? Perfect! This lets us focus on what truly matters - the perfect fit and function for YOUR unique needs.";
                            }

                            return "üé® Your style DNA is captured! Time to transform those preferences into the perfect eyewear that reflects your personality.";
                            
                        default:
                            return "üí° Great progress! Each answer helps us create your perfect vision solution.";
                    }
                };

                const titles = {
                    "What You Have": "Halfway There! üéâ",
                    "Current Setup": "Halfway There! üéâ",
                    "What You Need": "Needs Assessment Complete! üéØ",
                    "Lens Comfort & Eye Experience": "Vision Health Mapped! üëÅÔ∏è",
                    "Lifestyle & Vision Needs": "Lifestyle Decoded! üéØ",
                    "Sun, Style & Self-Expression": "Style Profile Ready! ‚ú®"
                };

                return {
                    title: titles[sectionName] || "Section Complete! ‚úÖ",
                    insight: sectionName === "What You Have" || sectionName === "Current Setup"
                        ? "We now know your setup. Let's identify what you're missing..."
                        : generateDynamicInsight(sectionName)
                };
            };

            const checkSectionCompletion = (newStep) => {
                const currentQuestion = questions[newStep - 1];
                const nextQuestion = questions[newStep];
                
                if (!currentQuestion || !nextQuestion) return false;
                
                return currentQuestion.section !== nextQuestion.section;
            };

            const continueAfterInsights = () => {
                setShowSectionComplete(false);
                let newStep = currentStep + 1;
                while (newStep < questions.length && questions[newStep].conditional && !questions[newStep].conditional(answers)) {
                    updateAnswer(newStep, 'skipped'); // Log skipped for AI if needed
                    newStep++;
                }
                setCurrentStep(newStep);
            };

            const nextStep = async () => {
                setShowAllBrands(false); // Reset brand expansion when moving to next question
                let newStep = currentStep + 1;
                
                // Skip Q10 and Q11 (indices 10, 11) - but don't skip celebration at index 9
                if (newStep === 10 || newStep === 11) {
                    updateAnswer(newStep, 'skipped'); // Log skipped for AI if needed
                    newStep++;
                    // Check if we need to skip Q11 after Q10
                    if (newStep === 11) {
                        updateAnswer(newStep, 'skipped');
                        newStep++;
                    }
                }
                
                while (newStep < questions.length && questions[newStep].conditional && !questions[newStep].conditional(answers)) {
                    updateAnswer(newStep, 'skipped'); // Log skipped for AI if needed
                    newStep++;
                }
                // Check if we're finishing the entire questionnaire
                if (newStep === questions.length) {
                    setCurrentStep(newStep);
                    setTimeout(() => {
                        generateAIInsights();
                    }, 100);
                    return;
                }
                
                // Only show section completion for intermediate sections (not the final one or intro transition)
                const currentQuestion = questions[currentStep];
                const nextQuestion = questions[newStep];
                const isChangingSection = currentQuestion && nextQuestion && currentQuestion.section !== nextQuestion.section;
                const isNotIntroTransition = currentQuestion && currentQuestion.type !== 'intro';
                
                // Only show section completion when moving from one content section to another
                // AND when we've actually completed meaningful questions in the current section
                if (newStep > 1 && isChangingSection && isNotIntroTransition) {
                    // Check if we've answered at least one question in the current section
                    let hasAnsweredInSection = false;
                    for (let i = 0; i <= currentStep; i++) {
                        if (questions[i].section === currentQuestion.section && answers[i] !== undefined) {
                            hasAnsweredInSection = true;
                            break;
                        }
                    }
                    
                    // Section completion disabled - using celebration slides instead
                    /* 
                    if (hasAnsweredInSection) {
                        const completedSection = questions[currentStep].section;
                        const sectionData = getSectionInsights(completedSection, answers);
                        setCompletedSectionData(sectionData);
                        setShowSectionComplete(true);
                        // Wait for user to click continue - no automatic timeout
                        return;
                    }
                    */
                }
                
                // Continue to next question
                setCurrentStep(newStep);
                
                // Scroll to top for new questions
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            };

            const prevStep = () => {
                let newStep = currentStep - 1;
                
                // Skip Q10 and Q11 (indices 9, 10) when going backwards
                if (newStep === 10 || newStep === 9) {
                    newStep--;
                    // Check if we need to skip Q10 after Q11
                    if (newStep === 9) {
                        newStep--;
                    }
                }
                
                while (newStep > 0 && questions[newStep].conditional && !questions[newStep].conditional(answers)) {
                    newStep--;
                }
                setCurrentStep(newStep);
            };

            const renderSectionComplete = () => {
                if (!completedSectionData) return null;
                
                return React.createElement('div', { className: "text-center space-y-6" },
                    React.createElement('div', { className: "relative w-24 h-24 mx-auto mb-6" },
                        React.createElement('div', { className: "w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center shadow-lg pulse-once" },
                            React.createElement('svg', { 
                                className: "w-12 h-12 text-white", 
                                fill: "none", 
                                stroke: "currentColor", 
                                viewBox: "0 0 24 24"
                            },
                                React.createElement('path', { 
                                    strokeLinecap: "round", 
                                    strokeLinejoin: "round", 
                                    strokeWidth: 3, 
                                    d: "M5 13l4 4L19 7"
                                })
                            )
                        )
                    ),
                    
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, completedSectionData.title),
                        React.createElement('p', { className: "text-lg text-gray-600 max-w-md mx-auto" }, completedSectionData.insight)
                    ),
                    
                    React.createElement('button', { 
                        className: "visionmatch-button text-white px-8 py-3 rounded-full font-semibold hover:shadow-lg transition-all duration-300 transform hover:scale-105 mt-4",
                        onClick: continueAfterInsights
                    }, "Continue ‚Üí")
                );
            };

            const renderQuestionContent = (q) => {
                if (q.type === 'slider') {
                    return React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', { className: "flex justify-between text-sm text-gray-600 px-2" },
                            React.createElement('span', null, q.sliderLabels[0]),
                            React.createElement('span', null, q.sliderLabels[1])
                        ),
                        React.createElement('div', { className: "relative px-4" },
                            React.createElement('input', {
                                type: "range",
                                min: "0",
                                max: "100",
                                value: answers[currentStep] || q.sliderDefault,
                                onChange: (e) => updateAnswer(currentStep, parseInt(e.target.value)),
                                className: "w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500",
                                style: {
                                    background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${answers[currentStep] || q.sliderDefault}%, #e5e7eb ${answers[currentStep] || q.sliderDefault}%, #e5e7eb 100%)`
                                }
                            })
                        )
                    );
                }
                
                // Single and multiple choice options
                if (q.options) {
                    return React.createElement('div', { className: "space-y-3" },
                        q.options.map((option, index) => 
                            React.createElement('button', {
                                key: index,
                                onClick: () => selectAnswer(option, currentStep),
                                className: `w-full p-4 text-left border-2 rounded-xl transition-all duration-200 ${
                                    answers[currentStep] === option || (Array.isArray(answers[currentStep]) && answers[currentStep].includes(option))
                                        ? 'border-primary-blue bg-blue-50 text-primary-blue-dark' 
                                        : 'border-gray-200 hover:border-primary-blue hover:bg-blue-50'
                                }`
                            }, option)
                        )
                    );
                }
                
                // Text input
                if (q.type === 'text') {
                    return React.createElement('textarea', {
                        value: answers[currentStep] || '',
                        onChange: (e) => updateAnswer(currentStep, e.target.value),
                        placeholder: q.placeholder || 'Your answer...',
                        className: "w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary-blue focus:outline-none resize-none h-32"
                    });
                }
                
                return null;
            };

            const renderQuestion = () => {
                if (currentStep >= questions.length) return renderResults();
                
                const q = questions[currentStep];

                if (q.type === 'slider' && answers[currentStep] === undefined) {
                    updateAnswer(currentStep, q.sliderDefault);
                }

                // Handle celebration slides
                if (q.type === 'celebration') {
                    // Trigger AI generation when celebration slide is shown
                    if (!personalitySummary && !isGeneratingSummary) {
                        generatePersonalitySummary().catch(console.error);
                    }

                    return React.createElement('div', { className: "w-full flex items-center justify-center min-h-[80vh] px-4" },
                        React.createElement('div', { className: "celebration-screen text-center space-y-8 max-w-3xl w-full mx-auto" },
                            React.createElement('div', { className: "w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6" },
                                React.createElement('div', { className: "w-8 h-8 bg-green-500 rounded-full" })
                            ),
                            React.createElement('p', { className: "text-sm text-green-600 font-medium uppercase tracking-wide" }, q.progress),
                            React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-8" }, q.title),
                            React.createElement('div', { className: "bg-blue-50 rounded-2xl p-8 mb-8 mx-auto border-2 border-blue-100 shadow-sm" },
                                isGeneratingSummary ? 
                                    React.createElement('div', { className: "flex items-center justify-center space-x-3" },
                                        React.createElement('div', { className: "animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600" }),
                                        React.createElement('p', { className: "text-lg text-gray-600" }, "Reading between the lines...")
                                    ) :
                                    React.createElement('p', { className: "text-xl text-gray-800 leading-relaxed font-medium" }, 
                                        personalitySummary || "You are the kind of person that probably cleans their glasses more often than they clean their car."
                                    )
                            ),
                            React.createElement('p', { className: "text-xl font-semibold text-gray-800 mb-8" }, "Let's now find out how we can optimise your setup"),
                            React.createElement('button', {
                                onClick: nextStep,
                                className: "visionmatch-button px-8 py-3 text-base font-semibold"
                            }, "Continue")
                        )
                    );
                }

                // Check if question has sidebar
                if (q.sidebar) {
                    return React.createElement('div', { className: "flex gap-8 max-w-6xl mx-auto" },
                        // Main question area
                        React.createElement('div', { className: "flex-1 space-y-6" },
                            React.createElement('h3', { className: "text-2xl font-semibold text-gray-800 text-center" }, q.question),
                            renderQuestionContent(q)
                        ),
                        // Sidebar
                        React.createElement('div', { className: "w-80 bg-blue-50 rounded-lg p-6 space-y-4" },
                            React.createElement('h4', { className: "text-lg font-semibold text-blue-900" }, q.sidebar.title),
                            React.createElement('p', { className: "text-blue-800 leading-relaxed" }, q.sidebar.content),
                            React.createElement('div', { className: "text-sm text-blue-700 border-t border-blue-200 pt-4 mt-4" },
                                q.sidebar.note.split(' ‚Ä¢ ').map((item, index) => 
                                    React.createElement('div', { key: index, className: "flex items-center space-x-2 mb-2" },
                                        React.createElement('div', { className: "w-2 h-2 bg-blue-600 rounded-full flex-shrink-0" }),
                                        React.createElement('span', null, item)
                                    )
                                )
                            )
                        )
                    );
                }

                return React.createElement('div', { className: "space-y-6" },
                    React.createElement('h3', { className: "text-2xl font-semibold text-gray-800 text-center" }, q.question),
                    
                    q.type === 'slider' ? 
                        React.createElement('div', { className: "space-y-6" },
                            React.createElement('div', { className: "flex justify-between text-sm text-gray-600 px-2" },
                                React.createElement('span', null, q.sliderLabels[0]),
                                React.createElement('span', null, q.sliderLabels[1])
                            ),
                            React.createElement('div', { className: "relative px-4" },
                                React.createElement('input', {
                                    type: "range",
                                    min: "0",
                                    max: "100",
                                    value: answers[currentStep] || q.sliderDefault,
                                    onChange: (e) => updateAnswer(currentStep, parseInt(e.target.value)),
                                    className: "w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500",
                                    style: {
                                        background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${answers[currentStep] || q.sliderDefault}%, #e5e7eb ${answers[currentStep] || q.sliderDefault}%, #e5e7eb 100%)`
                                    }
                                })
                            ),
                            React.createElement('div', { className: "text-center text-sm text-gray-500" },
                                q.question === "What is important for you in glasses?"
                                    ? `Current preference: ${
                                        (answers[currentStep] || q.sliderDefault) < 25 ? 'Strongly price focused' : 
                                        (answers[currentStep] || q.sliderDefault) < 50 ? 'Somewhat price focused' :
                                        (answers[currentStep] || q.sliderDefault) < 75 ? 'Somewhat style focused' : 
                                        'Strongly style focused'
                                    }`
                                    : q.question === "Are you happy with your current glasses?"
                                        ? `Current setting: ${
                                            (answers[currentStep] || q.sliderDefault) < 25 ? 'Very unhappy' : 
                                            (answers[currentStep] || q.sliderDefault) < 50 ? 'Somewhat unhappy' :
                                            (answers[currentStep] || q.sliderDefault) < 75 ? 'Somewhat happy' : 
                                            'Very happy'
                                        }`
                                        : q.question === "Do you think your current setup covers all your needs?"
                                            ? `Current setting: ${
                                                (answers[currentStep] || q.sliderDefault) < 25 ? 'Not at all' : 
                                                (answers[currentStep] || q.sliderDefault) < 50 ? 'Somewhat' :
                                                (answers[currentStep] || q.sliderDefault) < 75 ? 'Mostly' : 
                                                'Perfectly'
                                            }`
                                            : `Current setting: ${Math.round((answers[currentStep] || q.sliderDefault) / 10) * 10}%`
                            ),
                            
                            // Detail sections with multiple choice and text field for sliders
                            q.details && React.createElement('div', { className: "mt-8 text-center" },
                                React.createElement('div', { className: "bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4" },
                                    React.createElement('p', { className: "text-gray-700 text-sm mb-3 font-medium" }, "üí° Get better insights with more details"),
                                    React.createElement('button', {
                                        onClick: () => {
                                            setExpandedDetails(prev => ({
                                                ...prev,
                                                [currentStep]: !prev[currentStep]
                                            }));
                                        },
                                        className: "inline-flex items-center space-x-2 px-4 py-2 bg-blue-50 border border-blue-200 text-blue-700 hover:bg-blue-100 hover:border-blue-300 rounded-lg transition-all font-medium shadow-sm"
                                    },
                                    React.createElement('span', null, expandedDetails[currentStep] ? "Hide details" : q.details.prompt),
                                    React.createElement('svg', { 
                                        className: `w-4 h-4 transform transition-transform ${expandedDetails[currentStep] ? 'rotate-180' : ''}`,
                                        fill: "none", 
                                        stroke: "currentColor", 
                                        viewBox: "0 0 24 24" 
                                    },
                                        React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M19 9l-7 7-7-7" })
                                    )
                                )
                            ),
                                
                                // Expandable detail content for sliders
                                expandedDetails[currentStep] && React.createElement('div', { className: "mt-4 space-y-4 p-4 bg-gray-50 rounded-xl border border-gray-200 text-left" },
                                    // Multiple choice section
                                    q.details.multipleChoice && React.createElement('div', { className: "space-y-3" },
                                        React.createElement('h4', { className: "font-semibold text-gray-800" }, q.details.multipleChoice.question),
                                        React.createElement('div', { className: "space-y-2" },
                                            q.details.multipleChoice.options.map((option, index) =>
                                                React.createElement('button', {
                                                    key: index,
                                                    onClick: () => {
                                                        const current = detailAnswers[`${currentStep}_mc`] || [];
                                                        const updated = current.includes(option)
                                                            ? current.filter(item => item !== option)
                                                            : [...current, option];
                                                        setDetailAnswers(prev => ({
                                                            ...prev,
                                                            [`${currentStep}_mc`]: updated
                                                        }));
                                                    },
                                                    className: `w-full text-left p-3 rounded-lg border transition-all ${
                                                        (detailAnswers[`${currentStep}_mc`] || []).includes(option)
                                                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                            : 'border-gray-200 bg-white hover:border-gray-300'
                                                    }`
                                                },
                                                    React.createElement('div', { className: "flex items-center justify-between" },
                                                        React.createElement('span', { className: "font-medium flex-1" }, option),
                                                        React.createElement('div', {
                                                            className: `w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ml-3 ${
                                                                (detailAnswers[`${currentStep}_mc`] || []).includes(option)
                                                                    ? 'border-primary-blue bg-primary-blue'
                                                                    : 'border-gray-300'
                                                            }`
                                                        },
                                                            (detailAnswers[`${currentStep}_mc`] || []).includes(option) && 
                                                                React.createElement('svg', { className: "w-3 h-3 text-white", fill: "currentColor", viewBox: "0 0 20 20" },
                                                                    React.createElement('path', { fillRule: "evenodd", d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z", clipRule: "evenodd" })
                                                                )
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    ),
                                    
                                    // Text field section
                                    q.details.textField && React.createElement('div', { className: "space-y-3" },
                                        React.createElement('h4', { className: "font-semibold text-gray-800" }, q.details.textField.question),
                                        React.createElement('textarea', {
                                            value: detailAnswers[`${currentStep}_text`] || '',
                                            onChange: (e) => setDetailAnswers(prev => ({
                                                ...prev,
                                                [`${currentStep}_text`]: e.target.value
                                            })),
                                            placeholder: q.details.textField.placeholder,
                                            className: "w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                            rows: 3
                                        })
                                    ),
                                    
                                    // Continue button for when details are filled
                                    React.createElement('div', { className: "mt-6 pt-4 border-t border-gray-200" },
                                        React.createElement('button', {
                                            onClick: () => {
                                                if (currentStep !== 0) {
                                                    nextStep();
                                                }
                                            },
                                            className: "w-full flex items-center justify-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold"
                                        },
                                            React.createElement('span', null, "Continue"),
                                            React.createElement('svg', { className: "w-4 h-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 5l7 7-7 7" })
                                            )
                                        )
                                    )
                                )
                            )
                        ) :
                    q.type === 'text' ?
                        React.createElement('div', { className: "space-y-4" },
                            React.createElement('textarea', {
                                value: answers[currentStep] || '',
                                onChange: (e) => updateAnswer(currentStep, e.target.value),
                                placeholder: q.placeholder,
                                className: "w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                rows: 4
                            }),
                            React.createElement('div', { className: "text-center space-y-3" },
                                React.createElement('p', { className: "text-sm text-gray-500" },
                                    "üí° The more specific you are, the better we can tailor your recommendations!"
                                ),
                                React.createElement('button', {
                                    onClick: () => {
                                        updateAnswer(currentStep, 'skipped');
                                        nextStep();
                                    },
                                    className: "inline-flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all font-medium"
                                },
                                    React.createElement('span', null, "Skip this question"),
                                    React.createElement('svg', { className: "w-4 h-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                        React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M13 7l5 5m0 0l-5 5m5-5H6" })
                                    )
                                )
                            )
                        ) :
                    q.type === 'multi-step' ?
                        React.createElement('div', { className: "space-y-6" },
                            // Multi-step question renderer - progressive reveal
                            q.steps.map((step, stepIndex) => {
                                const stepAnswers = answers[currentStep] || {};
                                
                                // Show step 1 always, step 2 after step 1 is answered, step 3 after step 2 is answered
                                let shouldShowStep = stepIndex === 0 || 
                                    (stepIndex === 1 && stepAnswers[0]) ||
                                    (stepIndex === 2 && stepAnswers[0] && stepAnswers[1]);
                                
                                // Special logic for style question - skip step 2 if "No specific preference" or "I care about the fit" is selected
                                if (q.question === "What style do you like the most?" && stepIndex === 1 && stepAnswers[0]) {
                                    const firstStepAnswer = stepAnswers[0];
                                    const skipSecondStep = Array.isArray(firstStepAnswer) && 
                                        (firstStepAnswer.includes("No specific preference") || 
                                         firstStepAnswer.includes("I care about the fit, not the style"));
                                    if (skipSecondStep) {
                                        shouldShowStep = false;
                                    }
                                }
                                
                                if (!shouldShowStep) return null;
                                
                                return React.createElement('div', { 
                                    key: stepIndex, 
                                    id: `step-${stepIndex}`,
                                    className: "bg-gray-50 rounded-xl p-6 border border-gray-200 transition-all duration-500" 
                                },
                                    React.createElement('h4', { className: "text-lg font-semibold text-gray-800 mb-4" }, 
                                        `${stepIndex + 1}. ${step.question}`
                                    ),
                                    React.createElement('div', { 
                                        className: step.fullWidth 
                                            ? "grid grid-cols-1 gap-3"
                                            : step.gridLayout
                                                ? "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"
                                                : stepIndex === 0 
                                                    ? "grid grid-cols-2 md:grid-cols-3 gap-3" 
                                                    : stepIndex === 1 
                                                        ? "grid grid-cols-3 gap-3"
                                                        : "grid grid-cols-2 md:grid-cols-3 gap-3"
                                    },
                                        (() => {
                                            // Handle conditional options based on previous step
                                            let optionsToRender = step.options;
                                            if (step.conditionalOptions && stepIndex > 0) {
                                                const stepAnswers = answers[currentStep] || {};
                                                const previousAnswer = stepAnswers[stepIndex - 1];
                                                if (previousAnswer) {
                                                    // Handle both single answers and multiple selections
                                                    const selections = Array.isArray(previousAnswer) ? previousAnswer : [previousAnswer];
                                                    let combinedOptions = new Set();
                                                    
                                                    selections.forEach(selection => {
                                                        if (step.conditionalOptions[selection]) {
                                                            step.conditionalOptions[selection].forEach(option => 
                                                                combinedOptions.add(option)
                                                            );
                                                        }
                                                    });
                                                    
                                                    if (combinedOptions.size > 0) {
                                                        optionsToRender = Array.from(combinedOptions);
                                                    }
                                                }
                                            }
                                            return optionsToRender;
                                        })().map((option, optionIndex) =>
                                            React.createElement('button', {
                                                key: optionIndex,
                                                onClick: () => {
                                                    const stepAnswers = answers[currentStep] || {};
                                                    if (step.type === 'multiple') {
                                                        const current = stepAnswers[stepIndex] || [];
                                                        const updated = current.includes(option)
                                                            ? current.filter(item => item !== option)
                                                            : [...current, option];
                                                        updateAnswer(currentStep, { ...stepAnswers, [stepIndex]: updated });
                                                    } else {
                                                        updateAnswer(currentStep, { ...stepAnswers, [stepIndex]: option });
                                                        // Auto-scroll to next step after answering
                                                        setTimeout(() => {
                                                            const nextStep = document.getElementById(`step-${stepIndex + 1}`);
                                                            if (nextStep) {
                                                                nextStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                            }
                                                        }, 300);
                                                    }
                                                },
                                                className: `p-3 text-left rounded-lg border-2 transition-all duration-200 hover:border-blue-400 hover:bg-blue-50 text-sm h-12 flex items-center ${
                                                    step.type === 'multiple'
                                                        ? ((answers[currentStep] || {})[stepIndex] || []).includes(option)
                                                            ? 'border-blue-500 bg-blue-50 text-gray-800 font-medium'
                                                            : 'border-gray-200 bg-white'
                                                        : (answers[currentStep] || {})[stepIndex] === option
                                                            ? 'border-blue-500 bg-blue-50 text-gray-800 font-medium'
                                                            : 'border-gray-200 bg-white'
                                                }`
                                            },
                                                React.createElement('div', { className: "flex items-center justify-between" },
                                                    React.createElement('span', { className: "text-sm leading-tight flex-1" }, option),
                                                    step.type === 'multiple' && React.createElement('div', {
                                                        className: `w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ml-3 ${
                                                            ((answers[currentStep] || {})[stepIndex] || []).includes(option)
                                                                ? 'border-primary-blue bg-primary-blue'
                                                                : 'border-gray-300'
                                                        }`
                                                    },
                                                        ((answers[currentStep] || {})[stepIndex] || []).includes(option) &&
                                                        React.createElement('svg', { className: "w-3 h-3 text-white", fill: "currentColor", viewBox: "0 0 20 20" },
                                                            React.createElement('path', { fillRule: "evenodd", d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z", clipRule: "evenodd" })
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    ),
                                    // Text field for this step if needed
                                    step.textField && (() => {
                                        const stepAnswers = answers[currentStep] || {};
                                        const currentAnswer = stepAnswers[stepIndex];
                                        const shouldShow = step.textField.alwaysVisible || (step.textField.showWhen && (
                                            step.type === 'multiple' 
                                                ? (currentAnswer || []).includes(step.textField.showWhen)
                                                : currentAnswer === step.textField.showWhen
                                        ));
                                        return shouldShow;
                                    })() && React.createElement('div', { className: "mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4" },
                                        React.createElement('h5', { className: "font-semibold text-gray-800 mb-3 text-sm" }, step.textField.question),
                                        React.createElement('textarea', {
                                            value: (answers[currentStep] || {})[`${stepIndex}_text`] || '',
                                            onChange: (e) => {
                                                const stepAnswers = answers[currentStep] || {};
                                                updateAnswer(currentStep, { ...stepAnswers, [`${stepIndex}_text`]: e.target.value });
                                            },
                                            placeholder: step.textField.placeholder,
                                            className: "w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none text-sm",
                                            rows: 2
                                        })
                                    )
                                );
                            })
                        ) :
                    q.type === 'brand-selector' ?
                        (() => {
                            const selectedBrands = answers[currentStep] || [];
                            
                            const toggleBrand = (brand) => {
                                const updated = selectedBrands.includes(brand)
                                    ? selectedBrands.filter(item => item !== brand)
                                    : [...selectedBrands, brand];
                                updateAnswer(currentStep, updated);
                            };
                            
                            return React.createElement('div', { className: "space-y-6" },
                                // Popular brands section
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-lg font-semibold text-text-dark mb-4" }, "Popular Brands"),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                        q.popularBrands.map((brand, index) =>
                                            React.createElement('button', {
                                                key: index,
                                                onClick: () => toggleBrand(brand),
                                                className: `p-4 text-center rounded-xl border-2 transition-all duration-200 hover:border-primary-blue hover:bg-blue-50 hover:shadow-md ${
                                                    selectedBrands.includes(brand)
                                                        ? 'border-primary-blue bg-blue-50 text-text-dark shadow-md'
                                                        : 'border-gray-200 bg-white'
                                                }`
                                            }, brand)
                                        )
                                    )
                                ),
                                
                                // More brands toggle
                                React.createElement('div', { className: "text-center" },
                                    React.createElement('button', {
                                        onClick: () => setShowAllBrands(!showAllBrands),
                                        className: "inline-flex items-center space-x-2 px-6 py-3 text-primary-blue hover:text-primary-purple border border-primary-blue rounded-xl hover:bg-blue-50 transition-all font-medium"
                                    },
                                        React.createElement('span', null, showAllBrands ? 'Show Less' : 'More Brands...'),
                                        React.createElement('svg', { 
                                            className: `w-4 h-4 transform transition-transform ${showAllBrands ? 'rotate-180' : ''}`,
                                            fill: 'none',
                                            stroke: 'currentColor',
                                            viewBox: '0 0 24 24'
                                        },
                                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 9l-7 7-7-7' })
                                        )
                                    )
                                ),
                                
                                // All brands by category (expandable)
                                showAllBrands && React.createElement('div', { className: "space-y-4" },
                                    Object.entries(q.allBrands).map(([category, brands]) =>
                                        React.createElement('div', { key: category },
                                            React.createElement('h5', { className: "text-md font-medium text-gray-700 mb-2" }, category),
                                            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                                                brands.map((brand, index) =>
                                                    React.createElement('button', {
                                                        key: index,
                                                        onClick: () => toggleBrand(brand),
                                                        className: `p-2 text-sm text-center rounded-lg border transition-all duration-200 hover:border-primary-blue hover:bg-blue-50 ${
                                                            selectedBrands.includes(brand)
                                                                ? 'border-primary-blue bg-blue-50 text-text-dark'
                                                                : 'border-gray-200 bg-white text-gray-700'
                                                        }`
                                                    }, brand)
                                                )
                                            )
                                        )
                                    )
                                ),
                                
                                // Generic options
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-lg font-semibold text-text-dark mb-4" }, "Or..."),
                                    React.createElement('div', { className: "space-y-2" },
                                        q.genericOptions.map((option, index) =>
                                            React.createElement('button', {
                                                key: index,
                                                onClick: () => toggleBrand(option),
                                                className: `w-full p-4 text-left rounded-xl border-2 transition-all duration-200 hover:border-primary-blue hover:bg-blue-50 hover:shadow-md ${
                                                    selectedBrands.includes(option)
                                                        ? 'border-primary-blue bg-blue-50 text-text-dark shadow-md'
                                                        : 'border-gray-200 bg-white'
                                                }`
                                            }, option)
                                        )
                                    )
                                ),
                                
                                // Text field for additional brands
                                q.hasTextField && React.createElement('div', { className: "mt-6" },
                                    React.createElement('h4', { className: "text-lg font-semibold text-text-dark mb-4" }, "Additional Brands"),
                                    React.createElement('textarea', {
                                        value: answers[`${currentStep}_text`] || '',
                                        onChange: (e) => updateAnswer(`${currentStep}_text`, e.target.value),
                                        placeholder: q.textFieldPlaceholder,
                                        className: "w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                        rows: 3
                                    })
                                ),
                                
                                // Tell us more button for brand selector
                                React.createElement('div', { className: "mt-6 text-center" },
                                    React.createElement('button', {
                                        onClick: () => {
                                            setExpandedDetails(prev => ({
                                                ...prev,
                                                [currentStep]: !prev[currentStep]
                                            }));
                                        },
                                        className: "inline-flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all font-medium"
                                    },
                                        React.createElement('span', null, expandedDetails[currentStep] ? "Hide additional info" : "Tell us more"),
                                        React.createElement('svg', { 
                                            className: `w-4 h-4 transform transition-transform ${expandedDetails[currentStep] ? 'rotate-180' : ''}`,
                                            fill: "none", 
                                            stroke: "currentColor", 
                                            viewBox: "0 0 24 24" 
                                        },
                                            React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M19 9l-7 7-7-7" })
                                        )
                                    ),
                                    
                                    // Additional text field for brand selector
                                    expandedDetails[currentStep] && React.createElement('div', { className: "mt-4" },
                                        React.createElement('textarea', {
                                            value: answers[`${currentStep}_additional`] || '',
                                            onChange: (e) => updateAnswer(`${currentStep}_additional`, e.target.value),
                                            placeholder: "Any additional context about your brand preferences or style choices?",
                                            className: "w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                            rows: 3
                                        })
                                    )
                                )
                            );
                        })() :
                        React.createElement('div', { className: "space-y-3" },
                            q.options.map((option, index) =>
                                React.createElement('button', {
                                    key: index,
                                    onClick: () => {
                                        console.log(`üîç OPTION CLICKED: Step ${currentStep}, Option: "${option}", Question type: ${q.type}`);
                                        if (q.type === 'multiple') {
                                            const current = answers[currentStep] || [];
                                            console.log(`üîç Current answers for step ${currentStep}:`, current);
                                            
                                            // Special handling for Q8/index 7 (glasses usage) - "I always wear glasses"
                                            if (currentStep === 7 && option === "I always wear glasses") {
                                                console.log('üîç Q8 (index 7): "I always wear glasses" clicked, current selections:', current);
                                                console.log('üîç All available options:', q.options);
                                                if (current.includes(option)) {
                                                    // If "I always wear glasses" is being unchecked, remove only it
                                                    const updated = current.filter(item => item !== option);
                                                    console.log('‚ùå Unchecking "I always wear glasses", new selection:', updated);
                                                    updateAnswer(currentStep, updated);
                                                } else {
                                                    // If "I always wear glasses" is being checked, select ALL options including "I always wear glasses"
                                                    const allOptions = [...q.options];
                                                    console.log('‚úÖ AUTO-SELECTING ALL OPTIONS: Checking "I always wear glasses", selecting all options:', allOptions);
                                                    updateAnswer(currentStep, allOptions);
                                                }
                                            } else if (currentStep === 7 && current.includes("I always wear glasses")) {
                                                // If "I always wear glasses" is already selected and user clicks another option
                                                const updated = current.includes(option)
                                                    ? current.filter(item => item !== option)
                                                    : [...current, option];
                                                updateAnswer(currentStep, updated);
                                            } else {
                                                // Normal multiple choice behavior
                                                const updated = current.includes(option)
                                                    ? current.filter(item => item !== option)
                                                    : [...current, option];
                                                updateAnswer(currentStep, updated);
                                            }
                                        } else {
                                            updateAnswer(currentStep, option);
                                            // Auto-advance disabled to give users time to access detail sections
                                            // Users can manually continue using the Continue button at the bottom
                                        }
                                    },
                                    className: `w-full p-5 text-left rounded-xl border-2 transition-all duration-200 hover:border-primary-blue hover:bg-blue-50 hover:shadow-md ${
                                        q.type === 'multiple'
                                            ? (answers[currentStep] || []).includes(option)
                                                ? 'border-primary-blue bg-blue-50 text-text-dark shadow-md'
                                                : 'border-gray-200 bg-white'
                                            : answers[currentStep] === option
                                                ? 'border-primary-blue bg-blue-50 text-text-dark shadow-md'
                                                : 'border-gray-200 bg-white'
                                    }`
                                },
                                    React.createElement('div', { className: "flex items-center justify-between" },
                                        React.createElement('span', { className: "font-medium flex-1" }, option),
                                        q.type === 'multiple' && React.createElement('div', {
                                            className: `w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ml-3 ${
                                                (answers[currentStep] || []).includes(option)
                                                    ? 'border-primary-blue bg-primary-blue'
                                                    : 'border-gray-300'
                                            }`
                                        },
                                            (answers[currentStep] || []).includes(option) && 
                                                React.createElement('svg', { className: "w-3 h-3 text-white", fill: "currentColor", viewBox: "0 0 20 20" },
                                                    React.createElement('path', { fillRule: "evenodd", d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z", clipRule: "evenodd" })
                                                )
                                        )
                                    )
                                )
                            ),
                            
                            
                            // General textField for multiple choice questions when "Other" is selected OR alwaysVisible is true
                            (() => {
                                const hasOther = (answers[currentStep] || []).includes("Other");
                                const isAlwaysVisible = q.textField && q.textField.alwaysVisible;
                                const shouldShow = q.type === 'multiple' && q.textField && (hasOther || isAlwaysVisible);
                                console.log(`üîç TextField check - Step ${currentStep}, Question: "${q.question}", Type: ${q.type}, Has textField: ${!!q.textField}, Current answers:`, answers[currentStep], `Has "Other": ${hasOther}, Always visible: ${isAlwaysVisible}, Should show: ${shouldShow}`);
                                if (q.textField) {
                                    console.log(`üîç TextField config:`, q.textField);
                                }
                                return shouldShow;
                            })() && React.createElement('div', { className: "mt-4" },
                                React.createElement('div', { className: "bg-blue-50 border border-blue-200 rounded-lg p-4" },
                                    React.createElement('h4', { className: "font-semibold text-gray-800 mb-3" }, q.textField.question),
                                    React.createElement('textarea', {
                                        value: answers[`${currentStep}_textfield`] || '',
                                        onChange: (e) => updateAnswer(`${currentStep}_textfield`, e.target.value),
                                        placeholder: q.textField.placeholder,
                                        className: "w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                        rows: 3
                                    })
                                )
                            ),

                            // General textField for single choice questions when alwaysVisible is true
                            (() => {
                                const isAlwaysVisible = q.textField && q.textField.alwaysVisible;
                                const shouldShow = q.type === 'single' && q.textField && isAlwaysVisible;
                                return shouldShow;
                            })() && React.createElement('div', { className: "mt-4" },
                                React.createElement('div', { className: "bg-blue-50 border border-blue-200 rounded-lg p-4" },
                                    React.createElement('h4', { className: "font-semibold text-gray-800 mb-3" }, q.textField.question),
                                    React.createElement('textarea', {
                                        value: answers[`${currentStep}_textfield`] || '',
                                        onChange: (e) => updateAnswer(`${currentStep}_textfield`, e.target.value),
                                        placeholder: q.textField.placeholder,
                                        className: "w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                        rows: 3
                                    })
                                )
                            ),
                            
                            // Detail sections with multiple choice and text field
                            q.details && React.createElement('div', { className: "mt-8" },
                                React.createElement('div', { className: "bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4" },
                                    React.createElement('p', { className: "text-gray-700 text-sm mb-3 font-medium" }, "üí° Get better insights with more details"),
                                    React.createElement('button', {
                                        onClick: () => {
                                            setExpandedDetails(prev => ({
                                                ...prev,
                                                [currentStep]: !prev[currentStep]
                                            }));
                                        },
                                        className: "inline-flex items-center space-x-2 px-4 py-2 bg-blue-50 border border-blue-200 text-blue-700 hover:bg-blue-100 hover:border-blue-300 rounded-lg transition-all font-medium shadow-sm"
                                    },
                                    React.createElement('span', null, expandedDetails[currentStep] ? "Hide details" : q.details.prompt),
                                    React.createElement('svg', { 
                                        className: `w-4 h-4 transform transition-transform ${expandedDetails[currentStep] ? 'rotate-180' : ''}`,
                                        fill: "none", 
                                        stroke: "currentColor", 
                                        viewBox: "0 0 24 24" 
                                    },
                                        React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M19 9l-7 7-7-7" })
                                    )
                                )
                            ),
                                
                                // Expandable detail content
                                expandedDetails[currentStep] && React.createElement('div', { className: "mt-4 space-y-4 p-4 bg-gray-50 rounded-xl border border-gray-200" },
                                    // Multiple choice section
                                    q.details.multipleChoice && React.createElement('div', { className: "space-y-3" },
                                        React.createElement('h4', { className: "font-semibold text-gray-800" }, q.details.multipleChoice.question),
                                        React.createElement('div', { className: "space-y-2" },
                                            q.details.multipleChoice.options.map((option, index) =>
                                                React.createElement('button', {
                                                    key: index,
                                                    onClick: () => {
                                                        const current = detailAnswers[`${currentStep}_mc`] || [];
                                                        const updated = current.includes(option)
                                                            ? current.filter(item => item !== option)
                                                            : [...current, option];
                                                        setDetailAnswers(prev => ({
                                                            ...prev,
                                                            [`${currentStep}_mc`]: updated
                                                        }));
                                                    },
                                                    className: `w-full text-left p-3 rounded-lg border transition-all ${
                                                        (detailAnswers[`${currentStep}_mc`] || []).includes(option)
                                                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                            : 'border-gray-200 bg-white hover:border-gray-300'
                                                    }`
                                                },
                                                    React.createElement('div', { className: "flex items-center justify-between" },
                                                        React.createElement('span', { className: "font-medium flex-1" }, option),
                                                        React.createElement('div', {
                                                            className: `w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ml-3 ${
                                                                (detailAnswers[`${currentStep}_mc`] || []).includes(option)
                                                                    ? 'border-primary-blue bg-primary-blue'
                                                                    : 'border-gray-300'
                                                            }`
                                                        },
                                                            (detailAnswers[`${currentStep}_mc`] || []).includes(option) && 
                                                                React.createElement('svg', { className: "w-3 h-3 text-white", fill: "currentColor", viewBox: "0 0 20 20" },
                                                                    React.createElement('path', { fillRule: "evenodd", d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z", clipRule: "evenodd" })
                                                                )
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    ),
                                    
                                    // Text field section
                                    q.details.textField && React.createElement('div', { className: "space-y-3" },
                                        React.createElement('h4', { className: "font-semibold text-gray-800" }, q.details.textField.question),
                                        React.createElement('textarea', {
                                            value: detailAnswers[`${currentStep}_text`] || '',
                                            onChange: (e) => setDetailAnswers(prev => ({
                                                ...prev,
                                                [`${currentStep}_text`]: e.target.value
                                            })),
                                            placeholder: q.details.textField.placeholder,
                                            className: "w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none",
                                            rows: 3
                                        })
                                    ),
                                    
                                    // Continue button for when details are filled
                                    React.createElement('div', { className: "mt-6 pt-4 border-t border-gray-200" },
                                        React.createElement('button', {
                                            onClick: () => {
                                                if (currentStep !== 0) {
                                                    nextStep();
                                                }
                                            },
                                            className: "w-full flex items-center justify-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold"
                                        },
                                            React.createElement('span', null, "Continue"),
                                            React.createElement('svg', { className: "w-4 h-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 5l7 7-7 7" })
                                            )
                                        )
                                    )
                                )
                            )
                        )
                );
            };

            // Global cache for teaser results to avoid multiple API calls
            window.teaserCache = window.teaserCache || null;
            window.teaserPromise = window.teaserPromise || null;

            const generateTeaserWithGemini = async () => {
                // Return cached result if available
                if (window.teaserCache) {
                    console.log('üéØ Using cached teaser result');
                    return window.teaserCache;
                }

                // Return existing promise if already generating
                if (window.teaserPromise) {
                    console.log('‚è≥ Teaser generation already in progress...');
                    return window.teaserPromise;
                }

                // Create new promise
                window.teaserPromise = (async () => {
                    try {
                        console.log('ü§ñ Generating teaser result with Gemini...');
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyBwPLk8BhFMmAMWSAlKC3DOgPMNqL6BJXA`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: "You're a vision expert creating a short, compelling teaser result. Based on their questionnaire answers, create a personalized teaser that triggers interest and makes them want to learn more.\n\n" +
                                            "Their answers: " + JSON.stringify(answers, null, 2) + "\n\n" +
                                            "REQUIREMENTS:\n" +
                                            "- Keep the main result to 1-2 sentences maximum\n" +
                                            "- Make it specific and personal, not generic\n" +
                                            "- Focus on what they're missing or need to improve\n" +
                                            "- Create urgency/interest to continue\n" +
                                            "- Keep the insight short and actionable\n\n" +
                                            "Return ONLY a JSON object with 'result' and 'insight' fields. No other text."
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 200
                                }
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.log(`‚ùå Gemini API error ${response.status}:`, errorData);
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        const text = data.candidates[0].content.parts[0].text.trim();
                        
                        // Try to parse as JSON
                        let result;
                        try {
                            result = JSON.parse(text);
                        } catch {
                            // Fallback if not valid JSON
                            result = {
                                result: text.split('\n')[0] || "Your vision setup needs optimization.",
                                insight: "A personalized analysis will reveal exactly what you need."
                            };
                        }

                        // Cache the result
                        window.teaserCache = result;
                        console.log('‚úÖ Teaser generated and cached!');
                        return result;

                    } catch (error) {
                        console.error('‚ùå Error generating Gemini teaser:', error);
                        const fallbackResult = generateTeaserFallback();
                        window.teaserCache = fallbackResult; // Cache fallback too
                        return fallbackResult;
                    } finally {
                        window.teaserPromise = null; // Reset promise
                    }
                })();

                return window.teaserPromise;
            };

            const generateTeaserFallback = () => {
                const hasGlasses = answers[0] && answers[0].includes('glasses');
                const glassesCount = answers[1] || 'One';
                const glassesOwned = answers[2] || [];
                const screenTime = answers[10] || 'Unknown';
                const activities = answers[9] || [];
                const eyeSymptoms = answers[12] || [];
                const workEnvironment = answers[13] || {};
                const stylePrefs = answers[17] || {};
                
                // Create highly personalized result based on multiple answer points
                let result = "";
                let insight = "";
                
                // Screen time + symptoms analysis
                const hasEyeStrain = Array.isArray(eyeSymptoms) && eyeSymptoms.includes('Eye strain at screen');
                const hasHeadaches = Array.isArray(eyeSymptoms) && eyeSymptoms.includes('Headaches related to eyesight');
                const hasTiredEyes = Array.isArray(eyeSymptoms) && eyeSymptoms.includes('Tired eyes');
                const highScreenTime = screenTime.includes('More than 8') || screenTime.includes('6-8');
                
                if (highScreenTime && (hasEyeStrain || hasHeadaches || hasTiredEyes)) {
                    result = `With ${screenTime.toLowerCase()} of screen time daily and symptoms like ${eyeSymptoms.slice(0,2).join(' and ').toLowerCase()}, it seems like you might benefit from specialized computer glasses.`;
                    insight = "Computer glasses with blue light filtering could help reduce these symptoms and improve your daily comfort.";
                } else if (highScreenTime && !hasGlasses) {
                    result = `Given your ${screenTime.toLowerCase()} of daily screen time, you might find computer glasses helpful for eye comfort.`;
                    insight = "Even without prescription needs, computer glasses could make your work experience more comfortable.";
                } 
                // Active lifestyle analysis
                else if (Array.isArray(activities) && (activities.includes('Exercise or play sports') || activities.includes('Spend time outdoors'))) {
                    const activityList = activities.join(', ').toLowerCase();
                    result = `With your active lifestyle including ${activityList}, it looks like you could benefit from specialized sports eyewear.`;
                    insight = "Sports eyewear with impact resistance and UV protection might help keep you safe and performing at your best.";
                }
                // Multiple pairs analysis  
                else if (glassesCount === 'One' && hasGlasses && Array.isArray(glassesOwned) && glassesOwned.length > 1) {
                    result = `You have ${glassesOwned.join(', ').toLowerCase()} but seem to rely on one pair for everything. You might benefit from using different pairs for different activities.`;
                    insight = "Having specialized pairs for different activities could improve your vision quality and comfort throughout the day.";
                }
                // Style-conscious users
                else if (stylePrefs && Array.isArray(stylePrefs[0]) && stylePrefs[0].includes('Bold and statement-making')) {
                    result = "Based on your style preferences, it seems like you value frames that make a statement and express your personality.";
                    insight = "Finding frames that truly reflect your style could help you feel more confident and authentic.";
                }
                // No glasses but symptoms
                else if (!hasGlasses && (hasEyeStrain || hasHeadaches || hasTiredEyes)) {
                    const symptomList = eyeSymptoms.filter(s => s !== 'None of these').slice(0,2).join(' and ');
                    result = `You mentioned experiencing ${symptomList.toLowerCase()}, which might indicate that glasses could be helpful for you.`;
                    insight = "A professional eye exam could help determine what's causing these symptoms and whether glasses might help.";
                }
                // Default personalized
                else {
                    const personalDetails = [];
                    if (hasGlasses) personalDetails.push('current glasses user');
                    if (highScreenTime) personalDetails.push('heavy screen user');
                    if (Array.isArray(activities) && activities.length > 0) personalDetails.push(activities[0].toLowerCase());
                    
                    result = `As a ${personalDetails.join(', ')}, it looks like your vision setup could potentially be optimized for your specific lifestyle.`;
                    insight = "Small, targeted adjustments to your eyewear approach might make a noticeable difference in your daily comfort.";
                }
                
                return { result, insight };
            };

            const generatePersonalizedResult = async () => {
                try {
                    // Add small delay to prevent rapid multiple calls
                    if (!window.teaserCache && !window.teaserPromise) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return await generateTeaserWithGemini();
                } catch (error) {
                    console.error('Error in generatePersonalizedResult:', error);
                    return generateTeaserFallback();
                }
            };

            const renderResults = () => {
                // Step 1: Transition screen  
                if (resultStep === 'transition') {
                    return React.createElement('div', { className: "text-center space-y-8 max-w-2xl mx-auto" },
                        React.createElement('div', { className: "w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6" },
                            React.createElement('div', { className: "text-4xl" }, "üéâ")
                        ),
                        React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Great job! üéâ You've completed your Vision Match."),
                        React.createElement('p', { className: "text-lg text-gray-600 mb-8" }, "Now let's check your personalized result and how to get your free eye exam (included for everyone)."),
                        React.createElement('button', {
                            onClick: () => setResultStep('result'),
                            className: "visionmatch-button px-8 py-4 text-lg font-semibold"
                        }, "See My Result")
                    );
                }

                // Step 2: Personal result + data capture
                if (resultStep === 'result') {
                    // Use cached result directly or fallback
                    const personalizedResult = window.teaserCache || generateTeaserFallback();
                    console.log('üìä Result screen - using teaser result:', personalizedResult);
                    
                    return React.createElement('div', { className: "space-y-8 max-w-2xl mx-auto" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6" }, "Here's your Vision Match result üëá"),
                        
                        React.createElement('div', { className: "visionmatch-card p-6 shadow-lg bg-blue-50 border-l-4 border-primary-blue mb-8" },
                            React.createElement('p', { className: "text-lg text-blue-900 mb-4 font-semibold" }, 
                                personalizedResult.result
                            ),
                            React.createElement('p', { className: "text-blue-800" },
                                personalizedResult.insight
                            ),
                            React.createElement('p', { className: "text-blue-700 mt-4 text-sm font-medium" },
                                "Good news: With VisionMatch you'll never pay for lens upgrades ‚Äî they're free for life."
                            )
                        ),
                        
                        React.createElement('div', { className: "visionmatch-card p-6 shadow-sm" },
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Name"),
                                    React.createElement('input', {
                                        type: "text",
                                        value: userName,
                                        onChange: (e) => setUserName(e.target.value),
                                        className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent",
                                        placeholder: "Your full name"
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Email"),
                                    React.createElement('input', {
                                        type: "email",
                                        value: userEmail,
                                        onChange: (e) => setUserEmail(e.target.value),
                                        className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent",
                                        placeholder: "your.email@example.com"
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "ZIP Code"),
                                    React.createElement('input', {
                                        type: "text",
                                        value: userZipCode,
                                        onChange: (e) => setUserZipCode(e.target.value),
                                        className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent",
                                        placeholder: "Enter zip code to find nearest opticians"
                                    })
                                ),
                                React.createElement('button', {
                                    onClick: () => setResultStep('optician'),
                                    disabled: !userName || !userEmail || userZipCode.length < 5,
                                    className: `w-full py-3 px-6 rounded-lg font-semibold transition-colors ${
                                        userName && userEmail && userZipCode.length >= 5
                                            ? 'bg-primary-blue text-white hover:bg-primary-blue-dark'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`
                                }, "Send My Result & Find My Free Exam")
                            )
                        )
                    );
                }

                // Step 3: Optician selection
                if (resultStep === 'optician') {
                    const mockOpticians = [
                        { id: 1, name: "VisionCare Optometry", address: "123 Main St", hours: "Mon-Fri 9-6, Sat 9-4", distance: "0.5 mi" },
                        { id: 2, name: "Clear Sight Center", address: "456 Oak Ave", hours: "Mon-Sat 8-7", distance: "1.2 mi" },  
                        { id: 3, name: "Precision Eye Care", address: "789 Pine Rd", hours: "Tue-Sat 10-6", distance: "1.8 mi" }
                    ];

                    return React.createElement('div', { className: "space-y-6 max-w-2xl mx-auto" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Choose your free eye exam location"),
                        React.createElement('p', { className: "text-gray-600 mb-6" }, "Remember that you can add your existing glasses into the vision plan so that you can get a free lens upgrade when it's time to change them"),
                        
                        React.createElement('div', { className: "space-y-4" },
                            mockOpticians.map(optician =>
                                React.createElement('div', {
                                    key: optician.id,
                                    onClick: () => setSelectedOptician(optician),
                                    className: `visionmatch-card p-4 cursor-pointer transition-all ${
                                        selectedOptician?.id === optician.id 
                                            ? 'border-2 border-primary-blue bg-blue-50' 
                                            : 'border border-gray-200 hover:border-primary-blue'
                                    }`
                                },
                                    React.createElement('div', { className: "flex justify-between items-start" },
                                        React.createElement('div', { className: "flex-1" },
                                            React.createElement('h3', { className: "font-semibold text-gray-800 mb-1" }, optician.name),
                                            React.createElement('p', { className: "text-gray-600 text-sm mb-1" }, optician.address),
                                            React.createElement('p', { className: "text-gray-500 text-sm" }, optician.hours)
                                        ),
                                        React.createElement('div', { className: "text-right" },
                                            React.createElement('p', { className: "text-sm text-primary-blue font-medium" }, optician.distance),
                                            React.createElement('p', { className: "text-xs text-gray-500" }, "walking time")
                                        )
                                    )
                                )
                            )
                        ),
                        
                        selectedOptician && React.createElement('button', {
                            onClick: () => setResultStep('timeSlot'),
                            className: "w-full visionmatch-button py-3 px-6 font-semibold"
                        }, "Choose & Book")
                    );
                }

                // Step 4: Time slot selection
                if (resultStep === 'timeSlot') {
                    const timeSlots = ["10:00‚Äì12:00", "14:00‚Äì16:00", "16:00‚Äì18:00"];

                    return React.createElement('div', { className: "space-y-6 max-w-2xl mx-auto" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Pick a time that works for you"),
                        
                        React.createElement('div', { className: "space-y-3 mb-6" },
                            timeSlots.map(slot =>
                                React.createElement('button', {
                                    key: slot,
                                    onClick: () => setSelectedSlot(slot),
                                    className: `w-full p-4 text-left border-2 rounded-lg transition-all ${
                                        selectedSlot === slot 
                                            ? 'border-primary-blue bg-blue-50 text-primary-blue' 
                                            : 'border-gray-200 hover:border-primary-blue'
                                    }`
                                }, slot)
                            )
                        ),
                        
                        React.createElement('div', { className: "mb-6" },
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Phone Number (required for optician contact)"),
                            React.createElement('input', {
                                type: "tel",
                                value: userPhone,
                                onChange: (e) => setUserPhone(e.target.value),
                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue",
                                placeholder: "Your phone number"
                            })
                        ),
                        
                        (selectedSlot && userPhone) && React.createElement('button', {
                            onClick: () => setResultStep('confirmation'),
                            className: "w-full visionmatch-button py-3 px-6 font-semibold"
                        }, "Confirm My Free Exam")
                    );
                }

                // Step 5: Confirmation screen
                if (resultStep === 'confirmation') {
                    return React.createElement('div', { className: "space-y-8 max-w-2xl mx-auto text-center" },
                        React.createElement('div', { className: "w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6" },
                            React.createElement('div', { className: "text-4xl" }, "üéâ")
                        ),
                        React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "You're all set! üéâ"),
                        
                        React.createElement('div', { className: "visionmatch-card p-6 shadow-sm text-left mb-6" },
                            React.createElement('p', { className: "text-lg text-gray-800 mb-4" }, 
                                `Your free eye exam is booked at ${selectedOptician?.name} on ${selectedSlot}.`
                            ),
                            React.createElement('p', { className: "text-gray-600 mb-4" }, 
                                "The optician will contact you if they need to fine-tune your time."
                            ),
                            React.createElement('p', { className: "text-primary-blue font-medium" }, 
                                "This free exam will confirm your Vision Match result ‚Äî and unlock free lens upgrades for life."
                            )
                        ),
                        
                        React.createElement('div', { className: "flex flex-col space-y-3" },
                            React.createElement('button', {
                                onClick: () => alert('Calendar integration would be implemented here'),
                                className: "visionmatch-button py-3 px-6 font-semibold"
                            }, "Add to Calendar"),
                            React.createElement('button', {
                                onClick: () => setResultStep('emailConfirmation'),
                                className: "visionmatch-button py-3 px-6 font-semibold"
                            }, "View Email Confirmation"),
                            React.createElement('button', {
                                onClick: () => setResultStep('result'),
                                className: "py-3 px-6 border border-primary-blue text-primary-blue rounded-lg font-semibold hover:bg-blue-50"
                            }, "See My Result Again")
                        )
                    );
                }

                // Step 6: Email Confirmation Screen
                if (resultStep === 'emailConfirmation') {
                    // Get the cached result directly since teaser generation is working
                    const emailPersonalizedResult = window.teaserCache || generateTeaserFallback();
                    
                    console.log('üìß Email confirmation - using result:', emailPersonalizedResult);
                    
                    const today = new Date();
                    const examDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000); // 1 week from now
                    const formattedDate = examDate.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });

                    return React.createElement('div', { className: "space-y-8 max-w-4xl mx-auto" },
                        React.createElement('div', { className: "text-center mb-8" },
                            React.createElement('div', { className: "w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6" },
                                React.createElement('div', { className: "text-4xl" }, "‚úâÔ∏è")
                            ),
                            React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Email Confirmation Preview"),
                            React.createElement('p', { className: "text-gray-600" }, "This is what you'll receive in your inbox:")
                        ),
                        
                        // Email mockup container
                        React.createElement('div', { className: "bg-gray-50 p-8 rounded-xl border-2 border-dashed border-gray-300" },
                            React.createElement('div', { className: "bg-white rounded-lg shadow-lg max-w-2xl mx-auto overflow-hidden" },
                                // Email header
                                React.createElement('div', { className: "bg-primary-blue text-white p-6 text-center" },
                                    React.createElement('h3', { className: "text-2xl font-bold mb-2" }, "üéâ Your Free Eye Exam Is Confirmed"),
                                    React.createElement('p', { className: "text-blue-100" }, "VisionMatch Vision Match Results")
                                ),
                                
                                // Email body
                                React.createElement('div', { className: "p-8" },
                                    React.createElement('p', { className: "text-lg text-gray-800 mb-6" }, 
                                        `Hi ${userName || 'there'},`
                                    ),
                                    
                                    React.createElement('p', { className: "text-gray-700 mb-6" }, 
                                        "Thanks for completing your Vision Match! Based on your answers, we've prepared a free in-depth eye exam for you at:"
                                    ),
                                    
                                    // Appointment details
                                    React.createElement('div', { className: "bg-blue-50 p-6 rounded-xl mb-6" },
                                        React.createElement('div', { className: "flex items-center space-x-3 mb-3" },
                                            React.createElement('div', { className: "text-xl" }, "üìç"),
                                            React.createElement('span', { className: "font-semibold text-gray-800" }, selectedOptician?.name || "Your Selected Optician")
                                        ),
                                        React.createElement('div', { className: "flex items-center space-x-3 mb-3" },
                                            React.createElement('div', { className: "text-xl" }, "üìÖ"),
                                            React.createElement('span', { className: "text-gray-700" }, formattedDate)
                                        ),
                                        React.createElement('div', { className: "flex items-center space-x-3" },
                                            React.createElement('div', { className: "text-xl" }, "üïí"),
                                            React.createElement('span', { className: "text-gray-700" }, selectedSlot || "Your selected time slot")
                                        )
                                    ),
                                    
                                    React.createElement('p', { className: "text-gray-700 mb-6" }, 
                                        "Your optician will contact you if they need to adjust your time, but you're all set."
                                    ),
                                    
                                    // Your Vision Match Results section - Expert Optician Analysis
                                    React.createElement('div', { className: "border-t border-gray-200 pt-6 mb-6" },
                                        React.createElement('h4', { className: "text-xl font-bold text-gray-800 mb-4" }, "üë®‚Äç‚öïÔ∏è Your Expert Vision Analysis"),
                                        React.createElement('div', { className: "bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-xl" },
                                            React.createElement('div', { className: "space-y-6" },
                                                // Expert introduction
                                                React.createElement('div', { className: "bg-white p-4 rounded-lg border-l-4 border-blue-500" },
                                                    React.createElement('p', { className: "text-gray-700 text-sm italic mb-2" },
                                                        "Analysis by your VisionMatch expert optician with 30+ years of experience"
                                                    ),
                                                    React.createElement('p', { className: "text-gray-800 font-semibold" },
                                                        emailPersonalizedResult.result
                                                    )
                                                ),
                                                
                                                // Detailed expert analysis function
                                                (() => {
                                                    const generateExpertAnalysis = () => {
                                                        const currentGlasses = answers[0] || '';
                                                        const currentSetup = answers[1] || '';
                                                        const eyewearNeeds = answers[2] || '';
                                                        const lifestyle = answers[6] || '';
                                                        const screenTime = answers[7] || '';
                                                        const workEnv = answers[12] || '';  // Updated index after Q13 deletion
                                                        const age = answers[10] || '';
                                                        const visionIssues = answers[9] || '';
                                                        const style = answers[16] || '';  // Updated index
                                                        const currentFrames = answers[3] || '';
                                                        
                                                        let analysis = [];
                                                        
                                                        // Current situation analysis
                                                        analysis.push({
                                                            title: "üîç Your Current Eyewear Situation",
                                                            content: (() => {
                                                                let situation = "";
                                                                if (currentGlasses.includes('glasses')) {
                                                                    situation += "I can see you're currently wearing glasses, which is great - you're already taking care of your vision. ";
                                                                    if (currentSetup) {
                                                                        situation += `From what you've shared about your setup: "${currentSetup.substring(0, 100)}..." - this gives me good insight into how you use your eyewear daily. `;
                                                                    }
                                                                } else if (currentGlasses.includes('contact')) {
                                                                    situation += "You're using contact lenses, which offers excellent peripheral vision and freedom for activities. ";
                                                                } else {
                                                                    situation += "You mentioned you don't currently wear corrective eyewear. This could mean your vision is naturally good, or perhaps you haven't had a recent comprehensive exam. ";
                                                                }
                                                                
                                                                if (eyewearNeeds.includes('sunglasses')) {
                                                                    situation += "I notice you use sunglasses, which shows you understand the importance of UV protection - that's excellent preventive care.";
                                                                }
                                                                
                                                                return situation || "Let's work together to understand your vision needs better.";
                                                            })()
                                                        });
                                                        
                                                        // Lifestyle and vision demands analysis
                                                        analysis.push({
                                                            title: "üíº How Your Lifestyle Affects Your Vision",
                                                            content: (() => {
                                                                let lifestyle_analysis = "";
                                                                
                                                                if (screenTime.includes('8+ hours')) {
                                                                    lifestyle_analysis += "With 8+ hours of screen time daily, your eyes are working incredibly hard. This extended digital exposure often leads to what we call Computer Vision Syndrome - eye strain, dry eyes, and focusing fatigue. ";
                                                                } else if (screenTime.includes('4-8 hours')) {
                                                                    lifestyle_analysis += "Your 4-8 hours of daily screen time puts you in the moderate-to-high digital eye strain risk category. ";
                                                                }
                                                                
                                                                if (workEnv.includes('office')) {
                                                                    lifestyle_analysis += "Working in an office environment typically means artificial lighting and potentially glare from windows or screens. ";
                                                                } else if (workEnv.includes('outdoor')) {
                                                                    lifestyle_analysis += "Outdoor work exposes your eyes to UV radiation and varying light conditions throughout the day. ";
                                                                }
                                                                
                                                                if (lifestyle.includes('sports') || lifestyle.includes('exercise')) {
                                                                    lifestyle_analysis += "Your active lifestyle is wonderful for overall health, and it means your eyewear needs to keep up with you - providing clear vision and protection during physical activities.";
                                                                }
                                                                
                                                                return lifestyle_analysis || "Your daily activities will help us determine the best eyewear solutions for you.";
                                                            })()
                                                        });
                                                        
                                                        // Age-related vision changes
                                                        if (age.includes('40') || age.includes('50') || age.includes('Over')) {
                                                            analysis.push({
                                                                title: "üëÄ Understanding Age-Related Vision Changes",
                                                                content: "In your age group, it's completely normal to experience presbyopia - the gradual loss of near focusing ability. This isn't a flaw; it's a natural part of aging that affects virtually everyone. You might notice needing to hold reading material further away, or experiencing eye fatigue when switching between distance and near tasks. Progressive lenses or specialized computer glasses can make a tremendous difference in your daily comfort and visual efficiency."
                                                            });
                                                        }
                                                        
                                                        // Specific recommendations based on their answers
                                                        analysis.push({
                                                            title: "üí° My Professional Recommendations",
                                                            content: (() => {
                                                                let recommendations = "";
                                                                
                                                                // Blue light and computer work
                                                                if (screenTime.includes('4+') || screenTime.includes('8+')) {
                                                                    recommendations += "Given your significant screen time, I'd strongly recommend computer glasses with blue light filtering and anti-reflective coating. These reduce eye strain by filtering harmful blue light and eliminating reflections that cause your eyes to work harder. ";
                                                                }
                                                                
                                                                // Progressive lenses for presbyopia
                                                                const needsReading = visionIssues.includes('Reading') || visionIssues.includes('close-up');
                                                                const isPresbyopic = age.includes('40') || age.includes('50') || age.includes('Over');
                                                                if (needsReading && isPresbyopic) {
                                                                    recommendations += "Progressive lenses would be ideal for you - they provide seamless vision at all distances without the telltale lines of bifocals. Modern progressives are incredibly advanced and most people adapt within a week. ";
                                                                }
                                                                
                                                                // Prescription sunglasses
                                                                if (currentGlasses.includes('glasses') && eyewearNeeds.includes('sunglasses') && !eyewearNeeds.includes('prescription sunglasses')) {
                                                                    recommendations += "Since you wear glasses and regular sunglasses, prescription sunglasses would eliminate the hassle of switching between them. You'll have perfect vision outdoors with full UV protection. ";
                                                                }
                                                                
                                                                // Sports eyewear
                                                                if (lifestyle.includes('sports') && currentGlasses.includes('glasses')) {
                                                                    recommendations += "For your active lifestyle, consider sport-specific eyewear with impact-resistant lenses and secure, comfortable frames designed for movement. ";
                                                                }
                                                                
                                                                // Frame recommendations based on style
                                                                if (style.includes('Classic')) {
                                                                    recommendations += "Your classic style preference suggests you'd appreciate timeless frame designs that never go out of fashion - think clean lines and quality materials that age beautifully. ";
                                                                } else if (style.includes('Modern')) {
                                                                    recommendations += "With your modern style preference, we can explore contemporary frame designs with interesting details and current color trends. ";
                                                                }
                                                                
                                                                return recommendations || "A comprehensive eye exam will help us identify the perfect solutions for your unique vision needs.";
                                                            })()
                                                        });
                                                        
                                                        // What might not be working
                                                        if (currentSetup) {
                                                            analysis.push({
                                                                title: "‚ö†Ô∏è Potential Areas for Improvement",
                                                                content: (() => {
                                                                    let improvements = "Based on your current setup, here's what might be limiting your visual comfort: ";
                                                                    
                                                                    if (currentGlasses.includes('glasses') && !eyewearNeeds.includes('computer glasses') && screenTime.includes('4+')) {
                                                                        improvements += "Your regular glasses might not have the specialized coatings needed for extended computer work, leading to unnecessary eye strain. ";
                                                                    }
                                                                    
                                                                    if (currentGlasses.includes('glasses') && eyewearNeeds.includes('Plain sunglasses')) {
                                                                        improvements += "Using separate glasses and sunglasses means you're compromising vision clarity when outdoors - prescription sunglasses would solve this completely. ";
                                                                    }
                                                                    
                                                                    if (visionIssues.includes('headaches') || visionIssues.includes('eye strain')) {
                                                                        improvements += "The vision symptoms you mentioned often indicate that your current prescription might need updating, or that specialized lens features could provide relief. ";
                                                                    }
                                                                    
                                                                    return improvements;
                                                                })()
                                                            });
                                                        }
                                                        
                                                        return analysis;
                                                    };
                                                    
                                                    const expertAnalysis = generateExpertAnalysis();
                                                    
                                                    return React.createElement('div', { className: "space-y-4" },
                                                        expertAnalysis.map((section, index) => 
                                                            React.createElement('div', { 
                                                                key: index, 
                                                                className: "bg-white p-5 rounded-lg shadow-sm border border-gray-100" 
                                                            },
                                                                React.createElement('h6', { 
                                                                    className: "font-semibold text-gray-800 text-base mb-3" 
                                                                }, section.title),
                                                                React.createElement('p', { 
                                                                    className: "text-gray-700 text-sm leading-relaxed" 
                                                                }, section.content)
                                                            )
                                                        )
                                                    );
                                                })(),
                                                
                                                // Next steps
                                                React.createElement('div', { className: "bg-green-50 p-5 rounded-lg border border-green-200" },
                                                    React.createElement('h6', { className: "font-semibold text-green-800 text-base mb-3" }, 
                                                        "üéØ Your Next Steps"
                                                    ),
                                                    React.createElement('p', { className: "text-green-700 text-sm leading-relaxed" },
                                                        "During our appointment, I'll conduct a thorough eye examination to confirm these insights and ensure we're addressing all your vision needs. We'll discuss frame options that match your style and lifestyle, and I'll show you lens technologies that will make a real difference in your daily comfort and visual performance. Remember, great vision care is about more than just seeing clearly - it's about feeling confident and comfortable in everything you do."
                                                    )
                                                )
                                            )
                                        )
                                    ),
                                    
                                    React.createElement('div', { className: "bg-green-50 p-6 rounded-xl mb-6" },
                                        React.createElement('h5', { className: "font-semibold text-gray-800 mb-3" }, "Why this exam matters:"),
                                        React.createElement('ul', { className: "space-y-2 text-gray-700" },
                                            React.createElement('li', { className: "flex items-start space-x-2" },
                                                React.createElement('span', { className: "text-green-600 font-bold" }, "‚úÖ"),
                                                React.createElement('span', {}, "Confirms your Vision Match result with medical precision")
                                            ),
                                            React.createElement('li', { className: "flex items-start space-x-2" },
                                                React.createElement('span', { className: "text-green-600 font-bold" }, "‚úÖ"),
                                                React.createElement('span', {}, "Free of charge, no strings attached")
                                            ),
                                            React.createElement('li', { className: "flex items-start space-x-2" },
                                                React.createElement('span', { className: "text-green-600 font-bold" }, "‚úÖ"),
                                                React.createElement('span', {}, "Unlocks the benefits of VisionMatch: free lens upgrades for life + no upfront payment for glasses")
                                            )
                                        )
                                    ),
                                    
                                    React.createElement('div', { className: "text-center" },
                                        React.createElement('p', { className: "text-gray-700 mb-4" }, "Next Step:"),
                                        React.createElement('button', {
                                            onClick: () => alert('Calendar integration would be implemented here'),
                                            className: "visionmatch-button py-3 px-8 font-semibold mb-4"
                                        }, "üëâ Add to Calendar"),
                                        React.createElement('p', { className: "text-sm text-gray-600" }, 
                                            "We'll also send you a reminder by SMS before your appointment."
                                        )
                                    )
                                )
                            )
                        ),
                        
                        // Back button
                        React.createElement('div', { className: "text-center" },
                            React.createElement('button', {
                                onClick: () => setResultStep('confirmation'),
                                className: "py-3 px-6 border border-primary-blue text-primary-blue rounded-lg font-semibold hover:bg-blue-50"
                            }, "‚Üê Back to Confirmation")
                        )
                    );
                }

                return React.createElement('div', { className: "space-y-8" },
                    React.createElement('div', { className: "text-center" },
                        React.createElement('div', { className: "w-20 h-20 visionmatch-gradient rounded-full flex items-center justify-center mx-auto mb-6" },
                            React.createElement(Sparkles, { className: "w-10 h-10 text-white" })
                        ),
                        React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Your Personalized Vision Plan")
                    ),

                    React.createElement('div', { className: "visionmatch-card p-8 shadow-lg" },
                        React.createElement('div', { className: "flex items-start space-x-4 mb-6" },
                            React.createElement('div', { className: "w-16 h-16 visionmatch-gradient rounded-2xl flex items-center justify-center flex-shrink-0" },
                                React.createElement(Sparkles, { className: "w-8 h-8 text-white" })
                            ),
                            React.createElement('div', { className: "flex-1" },
                                React.createElement('h3', { className: "text-2xl font-bold text-gray-800 mb-2" }, "Your Vision Profile"),
                                React.createElement('p', { className: "text-gray-600" }, "AI-powered analysis based on your lifestyle and vision needs")
                            )
                        ),
                        
                        React.createElement('div', { className: "bg-white rounded-xl p-6 shadow-sm border border-gray-100" },
                            React.createElement('div', { className: "max-w-none" },
                                React.createElement('div', { className: "text-gray-700 leading-relaxed space-y-4" },
                                    aiInsights.split('\n').map((line, index) => {
                                        const trimmedLine = line.trim();
                                        if (!trimmedLine) return null;
                                        
                                        if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) {
                                            const headerText = trimmedLine.slice(2, -2);
                                            return React.createElement('h4', { 
                                                key: index, 
                                                className: "text-lg font-semibold text-gray-800 mb-3 mt-6 first:mt-0" 
                                            }, headerText);
                                        }
                                        
                                        if (trimmedLine.startsWith('‚Ä¢')) {
                                            const bulletText = trimmedLine.substring(1).trim();
                                            const processedText = bulletText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                            
                                            return React.createElement('div', { 
                                                key: index, 
                                                className: "flex items-start space-x-3 mb-3" 
                                            },
                                                React.createElement('div', { className: "w-2 h-2 bg-primary-blue rounded-full mt-3 flex-shrink-0" }),
                                                React.createElement('p', {
                                                    className: "m-0 text-base leading-relaxed text-gray-700",
                                                    dangerouslySetInnerHTML: { __html: processedText }
                                                })
                                            );
                                        }
                                        
                                        const processedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                        
                                        return React.createElement('p', {
                                            key: index,
                                            className: "m-0 text-base leading-relaxed text-gray-700",
                                            dangerouslySetInnerHTML: { __html: processedLine }
                                        });
                                    })
                                )
                            )
                        )
                    ),

                    // VisionMatch Protection & Optician CTA
                    React.createElement('div', { className: "visionmatch-card p-8 shadow-lg border-l-4 border-primary-blue" },
                        React.createElement('div', { className: "text-center space-y-4" },
                            React.createElement('h3', { className: "text-2xl font-bold text-gray-800" }, "üõ°Ô∏è Protect Your Investment"),
                            React.createElement('p', { className: "text-gray-600 text-lg" }, "Bring your current frames to our partner opticians to include them in VisionMatch protection, then add the new glasses you need."),
                            React.createElement('div', { className: "bg-blue-50 rounded-xl p-6 my-6" },
                                React.createElement('h4', { className: "font-semibold text-blue-800 mb-3" }, "What's Included:"),
                                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-3 text-left" },
                                    React.createElement('div', { className: "flex items-center space-x-2" },
                                        React.createElement('div', { className: "w-2 h-2 bg-blue-600 rounded-full" }),
                                        React.createElement('span', { className: "text-blue-700" }, "Full coverage for breakage & theft")
                                    ),
                                    React.createElement('div', { className: "flex items-center space-x-2" },
                                        React.createElement('div', { className: "w-2 h-2 bg-blue-600 rounded-full" }),
                                        React.createElement('span', { className: "text-blue-700" }, "Free lens updates when prescription changes")
                                    ),
                                    React.createElement('div', { className: "flex items-center space-x-2" },
                                        React.createElement('div', { className: "w-2 h-2 bg-blue-600 rounded-full" }),
                                        React.createElement('span', { className: "text-blue-700" }, "Professional fitting & adjustments")
                                    ),
                                    React.createElement('div', { className: "flex items-center space-x-2" },
                                        React.createElement('div', { className: "w-2 h-2 bg-blue-600 rounded-full" }),
                                        React.createElement('span', { className: "text-blue-700" }, "Complete peace of mind with full coverage")
                                    )
                                )
                            ),
                            React.createElement('button', {
                                onClick: () => setHasBookedExam(false), // Show booking calendar
                                className: "visionmatch-button inline-flex items-center space-x-3 text-white px-10 py-5 rounded-xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg"
                            },
                                React.createElement('span', null, "Book with Partner Optician"),
                                React.createElement('svg', { className: "w-6 h-6", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" }),
                                    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M15 11a3 3 0 11-6 0 3 3 0 016 0z" })
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "text-center" },
                        React.createElement('button', {
                            onClick: downloadResultsAsPDF,
                            className: "bg-gray-100 hover:bg-gray-200 text-gray-700 inline-flex items-center space-x-2 px-6 py-3 rounded-xl font-semibold transition-all"
                        },
                            React.createElement('svg', { className: "w-5 h-5", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" })
                            ),
                            React.createElement('span', null, "Download Report")
                        )
                    ),

                    !hasBookedExam ? renderBookingCalendar() : renderOpticiansList(),

                    React.createElement('div', { className: "text-center text-gray-500 text-sm" },
                        React.createElement('p', null, "üí° Tip: Bring your current glasses and this report to your appointment for the best experience!")
                    )
                );
            };

            const currentQuestion = questions[currentStep];
            const currentSection = currentStep >= questions.length ? "Your Personalized Results" : currentQuestion?.section;

            return React.createElement('div', { className: "min-h-screen pt-32 pb-12" },
                // VisionMatch Header
                React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('div', { className: "max-w-2xl mx-auto px-4" }
                    )
                ),
                React.createElement('div', { className: currentStep >= questions.length ? "max-w-4xl mx-auto px-4" : (questions[currentStep]?.type === 'celebration' ? "w-full" : "quiz-layout") },
                    currentStep >= questions.length ? React.createElement('div', { className: "w-full" },
                        renderResults()
                    ) : React.createElement('div', { className: "quiz-main" },
                        React.createElement('div', { className: "question-container mb-8" },
                            showSectionComplete ? renderSectionComplete() : renderQuestion()
                        ),

                        !showSectionComplete && React.createElement('div', { className: "flex justify-between items-center" },
                            React.createElement(React.Fragment, null,
                                React.createElement('button', {
                                    onClick: prevStep,
                                    disabled: currentStep === 0,
                                    className: `flex items-center space-x-2 px-8 py-4 rounded-xl font-semibold transition-all ${
                                        currentStep === 0
                                            ? 'text-gray-400 cursor-not-allowed'
                                            : 'text-text-light hover:text-text-dark hover:bg-white border border-gray-200'
                                    }`
                                },
                                    React.createElement(ChevronLeft, { className: "w-5 h-5" }),
                                    React.createElement('span', null, "Previous")
                                ),
                                currentStep < questions.length && 
                                    React.createElement('button', {
                                        onClick: nextStep,
                                        disabled: !isAnswered(),
                                        className: `flex items-center space-x-2 px-8 py-4 rounded-xl font-semibold transition-all ${
                                            isAnswered()
                                                ? 'visionmatch-button'
                                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                        }`
                                    },
                                        React.createElement('span', null, currentStep === questions.length - 1 ? 'Get My Results' : 'Next'),
                                        React.createElement(ChevronRight, { className: "w-5 h-5" })
                                    )
                            )
                        )
                    ), // Close quiz-main div
                    
                    // Sidebar with progress and education (hidden for celebration slides)
                    currentStep < questions.length && questions[currentStep]?.type !== 'celebration' && React.createElement('div', { className: "quiz-sidebar" },
                        // Progress section
                        React.createElement('div', { className: "progress-section" },
                            React.createElement('div', { className: "progress-header" },
                                `Question ${Math.min(currentStep + 1, questions.length)} of ${questions.length}`
                            ),
                            getSectionProgress().map((section, index) =>
                                React.createElement('div', { key: index, className: "section-progress" },
                                    React.createElement('div', { className: "section-name" },
                                        React.createElement('span', { 
                                            className: section.isActive ? 'text-blue-600' : section.isComplete ? 'text-green-600' : 'text-gray-400'
                                        }, section.name),
                                        React.createElement('span', { 
                                            className: section.isActive ? 'text-blue-600' : section.isComplete ? 'text-green-600' : 'text-gray-400'
                                        }, `${Math.round(section.progress)}%`)
                                    ),
                                    React.createElement('div', { className: "progress-bar-container" },
                                        React.createElement('div', {
                                            className: "progress-bar-fill",
                                            style: { 
                                                width: `${section.progress}%`,
                                                opacity: section.isActive || section.isComplete ? 1 : 0.3
                                            }
                                        })
                                    )
                                )
                            )
                        ),
                        
                        // Educational content
                        React.createElement('div', { className: "education-panel" },
                            (() => {
                                const educationalContent = getEducationalContent(currentStep, answers);
                                if (!educationalContent) return null;
                                
                                return React.createElement(React.Fragment, null,
                                    React.createElement('div', { className: "education-header" },
                                        React.createElement('div', { className: "education-icon" }, educationalContent.icon),
                                        React.createElement('h3', { className: "education-title" }, educationalContent.title)
                                    ),
                                    React.createElement('div', {
                                        className: "education-content",
                                        dangerouslySetInnerHTML: { __html: educationalContent.content }
                                    })
                                );
                            })()
                        )
                    )
                ) // Close quiz-layout div
            );
        };

        // Google Maps already initialized at page head

        // Initialize Google Maps for opticians when the component mounts
        window.initOpticiansMap = function() {
            const mapElement = document.getElementById('opticians-map');
            if (!mapElement) {
                console.warn('Opticians map element not found');
                return;
            }
            if (!window.google || !window.google.maps) {
                console.warn('Google Maps API not available');
                return;
            }

            const madrid = { lat: 40.4168, lng: -3.7038 };
            
            const map = new google.maps.Map(mapElement, {
                zoom: 14,
                center: madrid,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            const stores = [
                { name: "Optica Nova", position: { lat: 40.4168, lng: -3.7038 }, color: "red" },
                { name: "CentroVisi√≥n", position: { lat: 40.4155, lng: -3.7074 }, color: "blue" },
                { name: "√ìptica Bassol", position: { lat: 40.4378, lng: -3.6888 }, color: "green" }
            ];

            stores.forEach((store, index) => {
                const marker = new google.maps.Marker({
                    position: store.position,
                    map: map,
                    title: store.name,
                    label: {
                        text: String(index + 1),
                        color: "white",
                        fontWeight: "bold"
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: store.color === "red" ? "#ef4444" : store.color === "blue" ? "#3b82f6" : "#22c55e",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 2,
                        scale: 12
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: '<div class="p-2">' +
                        '<h3 class="font-bold text-gray-800">' + store.name + '</h3>' +
                        '<p class="text-sm text-gray-600">Click for directions</p>' +
                        '</div>'
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });
        };

        // Check if map should be initialized periodically
        const checkForMap = setInterval(() => {
            if (document.getElementById('opticians-map') && window.google) {
                window.initOpticiansMap();
                clearInterval(checkForMap);
            }
        }, 1000);

        // Use React 18 createRoot API instead of deprecated render
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(React.createElement(GlassesFinderWizard));
            } else {
                console.error('Root element not found. Make sure there is an element with id="root"');
            }
        });
    </script>
</body>
</html>
